<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ø³ÛŒØ³ØªÙ… Ù…Ø´Ø§ÙˆØ± | Ù…Ù‡Ø¯ÛŒ Ø¨Ø§Ù‚Ø±ÛŒØ§Ù†</title>
<link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
:root{
  --bg:#06080f;--surface:#0e1120;--surface2:#141828;--surface3:#1c2235;
  --border:#1e2640;--border2:#252f4a;
  --accent:#7c3aed;--accent2:#a855f7;--accent3:#06b6d4;
  --gold:#f59e0b;--success:#10b981;--danger:#ef4444;--warning:#f97316;
  --pink:#ec4899;--blue:#3b82f6;
  --text:#e2e8f0;--text-muted:#64748b;--text-dim:#94a3b8;
}
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'Vazirmatn',sans-serif;background:var(--bg);color:var(--text);min-height:100vh;overflow-x:hidden;direction:rtl}
body::before{content:'';position:fixed;inset:0;pointer-events:none;z-index:0;
  background:
    radial-gradient(ellipse 70% 50% at 20% 0%,rgba(124,58,237,0.08) 0%,transparent 60%),
    radial-gradient(ellipse 60% 40% at 80% 100%,rgba(168,85,247,0.06) 0%,transparent 50%),
    radial-gradient(ellipse 40% 30% at 50% 50%,rgba(6,182,212,0.03) 0%,transparent 60%);
}

/* ===== SCREENS ===== */
.screen{display:none;position:relative;z-index:1}
.screen.active{display:flex}

/* ===== WELCOME ===== */
#welcomeScreen{min-height:100vh;align-items:center;justify-content:center;padding:24px;flex-direction:column}
.welcome-wrap{width:100%;max-width:460px}
.welcome-advisor-card{
  background:linear-gradient(135deg,rgba(124,58,237,0.15),rgba(168,85,247,0.1));
  border:1px solid rgba(124,58,237,0.4);border-radius:20px;padding:28px;
  text-align:center;margin-bottom:24px;position:relative;overflow:hidden;
  animation:popIn 0.6s cubic-bezier(0.34,1.56,0.64,1);
}
.welcome-advisor-card::before{content:'';position:absolute;top:-50%;left:-50%;width:200%;height:200%;background:radial-gradient(ellipse at center,rgba(124,58,237,0.1) 0%,transparent 60%);pointer-events:none}
.wa-rank{font-size:11px;color:var(--accent2);font-weight:700;letter-spacing:2px;text-transform:uppercase;margin-bottom:8px}
.wa-name{font-size:28px;font-weight:900;background:linear-gradient(135deg,#fff,var(--accent2));-webkit-background-clip:text;-webkit-text-fill-color:transparent;margin-bottom:4px}
.wa-title{font-size:13px;color:var(--text-muted)}
.wa-badge{display:inline-flex;align-items:center;gap:6px;background:rgba(245,158,11,0.15);border:1px solid rgba(245,158,11,0.3);border-radius:20px;padding:4px 14px;font-size:12px;color:var(--gold);font-weight:700;margin-top:10px}

.welcome-box{background:var(--surface);border:1px solid var(--border2);border-radius:20px;padding:28px;animation:popIn 0.6s 0.1s both cubic-bezier(0.34,1.56,0.64,1)}
@keyframes popIn{from{opacity:0;transform:scale(0.9) translateY(20px)}to{opacity:1;transform:none}}
.welcome-sub{font-size:13px;color:var(--text-muted);margin-bottom:20px;text-align:center}
.role-btns{display:flex;flex-direction:column;gap:12px}
.role-btn{padding:16px 20px;border-radius:14px;border:1.5px solid var(--border2);background:var(--surface2);color:var(--text);font-family:'Vazirmatn',sans-serif;font-size:14px;font-weight:700;cursor:pointer;transition:all 0.3s;display:flex;align-items:center;gap:14px;text-align:right}
.role-btn.advisor-btn:hover{border-color:var(--accent);background:rgba(124,58,237,0.1);transform:translateY(-2px);box-shadow:0 8px 25px rgba(124,58,237,0.2)}
.role-btn.student-btn:hover{border-color:var(--accent3);background:rgba(6,182,212,0.08);transform:translateY(-2px)}
.rb-icon{font-size:26px;flex-shrink:0}
.rb-title{font-size:14px;font-weight:700}
.rb-sub{font-size:11px;color:var(--text-muted);font-weight:400;margin-top:2px}

/* ===== LOGIN ===== */
#loginScreen{min-height:100vh;align-items:center;justify-content:center;padding:24px}
.login-box{background:var(--surface);border:1px solid var(--border2);border-radius:24px;padding:44px 36px;width:100%;max-width:380px;text-align:center;box-shadow:0 0 60px rgba(124,58,237,0.08);animation:popIn 0.5s cubic-bezier(0.34,1.56,0.64,1)}
.login-logo{font-size:44px;margin-bottom:12px}
.login-title{font-size:20px;font-weight:800;margin-bottom:4px}
.login-sub{font-size:13px;color:var(--text-muted);margin-bottom:28px}
.login-input{width:100%;padding:13px 16px;background:var(--surface2);border:1.5px solid var(--border2);border-radius:11px;color:var(--text);font-family:'Vazirmatn',sans-serif;font-size:16px;text-align:center;letter-spacing:4px;margin-bottom:14px;outline:none;transition:all 0.2s}
.login-input:focus{border-color:var(--accent);box-shadow:0 0 0 3px rgba(124,58,237,0.15)}
.login-btn{width:100%;padding:13px;border-radius:11px;border:none;background:linear-gradient(135deg,var(--accent),var(--accent2));color:#fff;font-family:'Vazirmatn',sans-serif;font-size:15px;font-weight:700;cursor:pointer;transition:all 0.3s}
.login-btn:hover{transform:translateY(-2px);box-shadow:0 8px 25px rgba(124,58,237,0.4)}
.login-btn:disabled{opacity:0.6;cursor:not-allowed;transform:none}
.login-err{color:var(--danger);font-size:12px;margin-top:10px;display:none;padding:9px;background:rgba(239,68,68,0.08);border-radius:8px}
.back-link{margin-top:14px;font-size:12px;color:var(--text-muted);cursor:pointer;display:inline-block}
.back-link:hover{color:var(--accent)}

/* ===== PROFILE SETUP ===== */
#profileScreen{min-height:100vh;align-items:center;justify-content:center;padding:24px}
.profile-box{background:var(--surface);border:1px solid var(--border2);border-radius:24px;padding:40px 36px;width:100%;max-width:420px;box-shadow:0 0 60px rgba(124,58,237,0.1);animation:popIn 0.5s cubic-bezier(0.34,1.56,0.64,1)}
.profile-title{font-size:20px;font-weight:800;margin-bottom:4px;background:linear-gradient(135deg,var(--accent2),var(--accent3));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.profile-sub{font-size:13px;color:var(--text-muted);margin-bottom:24px;line-height:1.6}
.profile-name{font-size:24px;font-weight:900;color:var(--text);margin-bottom:4px}

/* ===== LOADING ===== */
.loading-overlay{position:fixed;inset:0;background:rgba(6,8,15,0.88);backdrop-filter:blur(8px);z-index:9999;display:none;align-items:center;justify-content:center;flex-direction:column;gap:16px}
.loading-overlay.show{display:flex}
.spinner{width:44px;height:44px;border:3px solid var(--border2);border-top-color:var(--accent);border-radius:50%;animation:spin 0.8s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
.loading-text{font-size:13px;color:var(--text-muted)}

/* ===== HEADER ===== */
#advisorApp,#studentApp{min-height:100vh;flex-direction:column}
header{padding:0 24px;height:58px;display:flex;align-items:center;justify-content:space-between;border-bottom:1px solid var(--border);background:rgba(6,8,15,0.88);backdrop-filter:blur(20px);position:sticky;top:0;z-index:100;flex-shrink:0}
.logo{display:flex;align-items:center;gap:10px}
.logo-icon{width:34px;height:34px;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:15px;background:linear-gradient(135deg,var(--accent),var(--accent2))}
.logo-name{font-size:14px;font-weight:800;background:linear-gradient(90deg,var(--accent2),var(--accent3));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.logo-role{font-size:10px;color:var(--text-muted)}
nav{display:flex;gap:3px}
.nav-btn{padding:6px 11px;border-radius:8px;border:1px solid transparent;background:transparent;color:var(--text-muted);font-family:'Vazirmatn',sans-serif;font-size:12px;cursor:pointer;transition:all 0.2s}
.nav-btn.active{background:rgba(124,58,237,0.15);border-color:rgba(124,58,237,0.4);color:var(--accent2)}
.nav-btn:hover:not(.active){color:var(--text);background:var(--surface2)}
.logout-btn{padding:5px 11px;border-radius:8px;border:1px solid var(--border2);background:transparent;color:var(--text-muted);font-family:'Vazirmatn',sans-serif;font-size:11px;cursor:pointer;transition:all 0.2s}
.logout-btn:hover{border-color:var(--danger);color:var(--danger)}

/* ===== MAIN ===== */
.main{max-width:980px;margin:0 auto;padding:24px 20px 60px;flex:1;width:100%}
.page-section{display:none}
.page-section.active{display:block;animation:fadeUp 0.3s ease}
@keyframes fadeUp{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:none}}

/* ===== CARDS ===== */
.card{background:var(--surface);border:1px solid var(--border);border-radius:16px;padding:20px;margin-bottom:16px}
.card-hdr{display:flex;align-items:center;justify-content:space-between;margin-bottom:16px}
.card-title{font-size:13px;font-weight:700;display:flex;align-items:center;gap:8px}
.ibox{width:26px;height:26px;border-radius:7px;display:flex;align-items:center;justify-content:center;font-size:12px;flex-shrink:0}
.ib-purple{background:rgba(124,58,237,0.2)}.ib-cyan{background:rgba(6,182,212,0.2)}.ib-green{background:rgba(16,185,129,0.2)}.ib-gold{background:rgba(245,158,11,0.2)}.ib-pink{background:rgba(236,72,153,0.2)}.ib-blue{background:rgba(59,130,246,0.2)}.ib-red{background:rgba(239,68,68,0.2)}
.page-hdr{margin-bottom:20px}
.page-hdr h1{font-size:19px;font-weight:800;margin-bottom:3px}
.page-hdr p{font-size:12px;color:var(--text-muted)}

/* ===== STATS ===== */
.stats-row{display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-bottom:18px}
.stat-card{background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:16px;text-align:center;transition:border-color 0.2s}
.stat-card:hover{border-color:var(--border2)}
.stat-num{font-size:24px;font-weight:900;margin-bottom:3px}
.stat-lbl{font-size:10px;color:var(--text-muted)}
.c-purple{color:var(--accent2)}.c-cyan{color:var(--accent3)}.c-green{color:var(--success)}.c-gold{color:var(--gold)}.c-pink{color:var(--pink)}.c-blue{color:var(--blue)}

/* ===== FORM ===== */
.form-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
.form-group{display:flex;flex-direction:column;gap:6px}
.form-group.full{grid-column:1/-1}
label{font-size:11px;color:var(--text-dim);font-weight:600;letter-spacing:0.3px}
input,select,textarea{background:var(--surface2);border:1px solid var(--border2);border-radius:9px;padding:10px 13px;color:var(--text);font-family:'Vazirmatn',sans-serif;font-size:13px;outline:none;transition:all 0.2s;direction:rtl;width:100%}
input:focus,select:focus,textarea:focus{border-color:var(--accent);box-shadow:0 0 0 3px rgba(124,58,237,0.12)}
select option{background:var(--surface)}

/* ===== BUTTONS ===== */
.btn{padding:8px 16px;border-radius:9px;border:none;font-family:'Vazirmatn',sans-serif;font-size:12px;font-weight:700;cursor:pointer;transition:all 0.2s;display:inline-flex;align-items:center;gap:5px}
.btn-primary{background:linear-gradient(135deg,var(--accent),var(--accent2));color:#fff}
.btn-primary:hover{transform:translateY(-1px);box-shadow:0 5px 18px rgba(124,58,237,0.35)}
.btn-outline{background:transparent;border:1px solid var(--border2);color:var(--text-dim)}
.btn-outline:hover{border-color:var(--accent);color:var(--accent)}
.btn-danger{background:rgba(239,68,68,0.1);border:1px solid rgba(239,68,68,0.3);color:var(--danger)}
.btn-success{background:rgba(16,185,129,0.1);border:1px solid rgba(16,185,129,0.3);color:var(--success)}
.btn-gold{background:rgba(245,158,11,0.1);border:1px solid rgba(245,158,11,0.3);color:var(--gold)}
.btn-sm{padding:5px 10px;font-size:11px;border-radius:7px}
.btn:disabled{opacity:0.5;cursor:not-allowed;transform:none!important}

/* ===== BADGE ===== */
.badge{padding:3px 9px;border-radius:20px;font-size:11px;font-weight:700;display:inline-block}
.bg-green{background:rgba(16,185,129,0.15);color:var(--success)}.bg-red{background:rgba(239,68,68,0.15);color:var(--danger)}.bg-amber{background:rgba(245,158,11,0.15);color:var(--gold)}.bg-blue{background:rgba(59,130,246,0.15);color:var(--blue)}.bg-purple{background:rgba(124,58,237,0.15);color:var(--accent2)}.bg-cyan{background:rgba(6,182,212,0.15);color:var(--accent3)}.bg-pink{background:rgba(236,72,153,0.15);color:var(--pink)}

/* ===== TABLE ===== */
.table-wrap{overflow-x:auto;border-radius:12px;border:1px solid var(--border)}
table{width:100%;border-collapse:collapse}
th{padding:10px 14px;text-align:right;font-size:11px;color:var(--text-muted);font-weight:600;background:var(--surface2);border-bottom:1px solid var(--border)}
td{padding:10px 14px;text-align:right;font-size:12px;border-bottom:1px solid rgba(30,38,64,0.4)}
tr:last-child td{border-bottom:none}
tr:hover td{background:rgba(124,58,237,0.02)}

/* ===== REPORT ROW ===== */
.report-row{background:var(--surface2);border:1px solid var(--border);border-radius:11px;padding:12px 16px;cursor:pointer;transition:all 0.2s;margin-bottom:7px;display:flex;align-items:center;gap:12px;flex-wrap:wrap}
.report-row:hover{border-color:var(--accent);transform:translateX(-3px)}

/* ===== STUDENT CARDS ===== */
.students-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(230px,1fr));gap:12px}
.student-card{background:var(--surface);border:1px solid var(--border);border-radius:13px;padding:16px;cursor:pointer;transition:all 0.2s;position:relative;overflow:hidden}
.student-card::before{content:'';position:absolute;top:0;left:0;right:0;height:3px;background:linear-gradient(90deg,var(--accent),var(--accent2));opacity:0;transition:opacity 0.2s}
.student-card:hover{border-color:var(--border2);transform:translateY(-2px);box-shadow:0 8px 28px rgba(0,0,0,0.3)}
.student-card:hover::before{opacity:1}
.code-tag{background:var(--surface3);border:1px solid var(--border2);border-radius:7px;padding:3px 9px;font-size:11px;color:var(--accent2);font-family:monospace;letter-spacing:1px;cursor:pointer;transition:all 0.2s}
.code-tag:hover{background:rgba(124,58,237,0.15)}

/* ===== SUBSCRIPTION STATUS ===== */
.sub-active{background:rgba(16,185,129,0.1);border:1px solid rgba(16,185,129,0.3);border-radius:8px;padding:6px 12px;font-size:11px;color:var(--success);display:inline-flex;align-items:center;gap:5px}
.sub-expired{background:rgba(239,68,68,0.1);border:1px solid rgba(239,68,68,0.3);border-radius:8px;padding:6px 12px;font-size:11px;color:var(--danger);display:inline-flex;align-items:center;gap:5px;animation:pulse 2s infinite}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:0.7}}
.sub-warning{background:rgba(245,158,11,0.1);border:1px solid rgba(245,158,11,0.3);border-radius:8px;padding:6px 12px;font-size:11px;color:var(--gold);display:inline-flex;align-items:center;gap:5px}

/* ===== STUDENT DASHBOARD HERO ===== */
.student-hero{
  background:linear-gradient(135deg,rgba(124,58,237,0.12),rgba(6,182,212,0.08));
  border:1px solid rgba(124,58,237,0.25);border-radius:18px;padding:24px;margin-bottom:16px;position:relative;overflow:hidden;
}
.student-hero::before{content:'';position:absolute;top:-30px;right:-30px;width:120px;height:120px;border-radius:50%;background:radial-gradient(circle,rgba(124,58,237,0.15) 0%,transparent 70%);pointer-events:none}
.sh-name{font-size:22px;font-weight:900;margin-bottom:4px}
.sh-info{font-size:12px;color:var(--text-muted);margin-bottom:18px;display:flex;gap:14px;flex-wrap:wrap}
.sh-info span{display:flex;align-items:center;gap:4px}

.countdown-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:16px}
.countdown-box{background:rgba(0,0,0,0.3);border-radius:12px;padding:14px;text-align:center;border:1px solid var(--border2)}
.cd-label{font-size:10px;color:var(--text-muted);margin-bottom:6px;font-weight:600;letter-spacing:0.5px}
.cd-days{font-size:32px;font-weight:900;line-height:1}
.cd-unit{font-size:10px;color:var(--text-muted);margin-top:3px}
.cd-exp{font-size:11px;font-weight:700;margin-top:4px}
.cd-tajrobi .cd-days{color:var(--success)}
.cd-riazi .cd-days{color:var(--blue)}

.sub-status-box{border-radius:12px;padding:14px 16px;display:flex;align-items:center;gap:12px}
.sub-ok{background:rgba(16,185,129,0.08);border:1px solid rgba(16,185,129,0.25)}
.sub-warn{background:rgba(245,158,11,0.08);border:1px solid rgba(245,158,11,0.25)}
.sub-bad{background:rgba(239,68,68,0.08);border:1px solid rgba(239,68,68,0.3);animation:pulse 2s infinite}
.ssb-icon{font-size:28px;flex-shrink:0}
.ssb-title{font-size:13px;font-weight:700;margin-bottom:3px}
.ssb-sub{font-size:11px;color:var(--text-muted)}

/* ===== LESSONS ===== */
.lessons-container{display:flex;flex-direction:column;gap:9px}
.lesson-row{background:var(--surface2);border:1px solid var(--border2);border-radius:11px;padding:13px;position:relative;animation:slideR 0.2s ease}
@keyframes slideR{from{opacity:0;transform:translateX(-8px)}to{opacity:1;transform:none}}
.lesson-top{display:grid;grid-template-columns:2fr 1fr 1fr;gap:9px;margin-bottom:9px;align-items:end}
.lesson-bot{display:grid;grid-template-columns:1fr 1fr 1fr 1fr;gap:8px;margin-bottom:9px;align-items:end}
.lesson-note{margin-top:0}
.rm-btn{position:absolute;top:9px;left:9px;width:22px;height:22px;border-radius:50%;background:rgba(239,68,68,0.12);border:1px solid rgba(239,68,68,0.3);color:var(--danger);cursor:pointer;font-size:11px;display:flex;align-items:center;justify-content:center;transition:all 0.2s}
.rm-btn:hover{background:rgba(239,68,68,0.25)}
.add-btn{width:100%;padding:10px;border:1.5px dashed var(--border2);border-radius:9px;background:transparent;color:var(--accent2);font-family:'Vazirmatn',sans-serif;font-size:12px;cursor:pointer;transition:all 0.2s;margin-top:9px}
.add-btn:hover{border-color:var(--accent2);background:rgba(124,58,237,0.06)}

/* ===== SUMMARY ===== */
.sum-row{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-bottom:16px}
.sum-card{background:var(--surface2);border:1px solid var(--border2);border-radius:11px;padding:14px;text-align:center}
.sum-val{font-size:22px;font-weight:800;margin-bottom:2px}
.sum-lbl{font-size:10px;color:var(--text-muted)}

/* ===== SAT SLIDER ===== */
.sat-row{display:flex;align-items:center;justify-content:space-between;margin-bottom:9px}
.sat-num{font-size:28px;font-weight:900;color:var(--accent2)}
.sat-emoji{font-size:26px}
input[type=range]{-webkit-appearance:none;appearance:none;height:7px;border-radius:4px;background:var(--surface2);border:none;padding:0;cursor:pointer;width:100%}
input[type=range]::-webkit-slider-thumb{-webkit-appearance:none;width:20px;height:20px;border-radius:50%;background:linear-gradient(135deg,var(--accent),var(--accent2));cursor:pointer;box-shadow:0 0 10px rgba(124,58,237,0.5);border:2px solid var(--bg)}

.submit-btn{width:100%;padding:14px;border-radius:11px;border:none;background:linear-gradient(135deg,var(--accent),var(--accent2));color:#fff;font-family:'Vazirmatn',sans-serif;font-size:14px;font-weight:800;cursor:pointer;transition:all 0.3s}
.submit-btn:hover{transform:translateY(-2px);box-shadow:0 8px 25px rgba(124,58,237,0.4)}
.submit-btn:disabled{opacity:0.6;cursor:not-allowed;transform:none}

/* ===== STREAK ===== */
.streak-card{background:linear-gradient(135deg,rgba(245,158,11,0.08),rgba(249,115,22,0.06));border:1px solid rgba(245,158,11,0.2);border-radius:13px;padding:14px 18px;display:flex;align-items:center;gap:14px;margin-bottom:16px}

/* ===== MODAL ===== */
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.8);backdrop-filter:blur(8px);z-index:500;display:none;align-items:center;justify-content:center;padding:20px}
.modal-overlay.open{display:flex}
.modal{background:var(--surface);border:1px solid var(--border2);border-radius:18px;padding:22px;width:100%;max-width:660px;max-height:88vh;overflow-y:auto;animation:mIn 0.3s cubic-bezier(0.34,1.56,0.64,1)}
@keyframes mIn{from{opacity:0;transform:scale(0.92)}to{opacity:1;transform:none}}
.modal-hdr{display:flex;align-items:center;justify-content:space-between;margin-bottom:18px;padding-bottom:14px;border-bottom:1px solid var(--border)}
.modal-title{font-size:15px;font-weight:800}
.close-btn{width:26px;height:26px;border-radius:7px;background:var(--surface2);border:1px solid var(--border);color:var(--text);cursor:pointer;font-size:14px;display:flex;align-items:center;justify-content:center;transition:all 0.2s}
.close-btn:hover{background:var(--border)}

/* ===== REPORT DETAIL ===== */
.report-detail-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-bottom:16px}
.report-lesson-card{background:var(--surface2);border:1px solid var(--border2);border-radius:10px;padding:12px;margin-bottom:8px}
.rlc-name{font-size:14px;font-weight:800;color:var(--accent2);margin-bottom:8px;display:flex;align-items:center;gap:6px}
.rlc-stats{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:8px}
.rlc-note{font-size:12px;color:var(--text-dim);background:rgba(124,58,237,0.06);border:1px solid rgba(124,58,237,0.15);border-radius:7px;padding:8px 10px;line-height:1.6}

/* ===== CHART ===== */
.chart-box{background:var(--surface2);border-radius:11px;padding:13px;overflow-x:auto;margin-bottom:14px}

/* ===== EMPTY ===== */
.empty{text-align:center;padding:36px;color:var(--text-muted)}
.empty-icon{font-size:34px;margin-bottom:9px}

/* ===== TOAST ===== */
.toast{position:fixed;bottom:24px;left:50%;transform:translateX(-50%) translateY(100px);background:var(--success);color:#fff;padding:11px 20px;border-radius:11px;font-size:13px;font-weight:700;transition:transform 0.4s cubic-bezier(0.34,1.56,0.64,1);z-index:9998;white-space:nowrap}
.toast.show{transform:translateX(-50%) translateY(0)}

/* ===== RENEW PANEL ===== */
.renew-box{background:var(--surface2);border:1px solid var(--border2);border-radius:11px;padding:12px;margin-top:10px;display:flex;align-items:center;gap:10px;flex-wrap:wrap}

::-webkit-scrollbar{width:5px;height:5px}
::-webkit-scrollbar-track{background:transparent}
::-webkit-scrollbar-thumb{background:var(--border2);border-radius:3px}

@media(max-width:640px){
  header{padding:0 12px}
  .main{padding:14px 12px 60px}
  .stats-row{grid-template-columns:1fr 1fr}
  .form-grid{grid-template-columns:1fr}
  .lesson-top{grid-template-columns:1fr 1fr}
  .lesson-bot{grid-template-columns:1fr 1fr}
  .countdown-grid{grid-template-columns:1fr 1fr}
  nav .nav-btn span{display:none}
  .welcome-advisor-card .wa-name{font-size:22px}
}
</style>
</head>
<body>

<!-- LOADING -->
<div class="loading-overlay" id="loadingOverlay">
  <div class="spinner"></div>
  <div class="loading-text" id="loadingText">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ...</div>
</div>

<!-- WELCOME -->
<div class="screen active" id="welcomeScreen">
  <div class="welcome-wrap">
    <div class="welcome-advisor-card">
      <div class="wa-rank">ğŸ† Ø±ØªØ¨Ù‡ Û¶Û³ Ú©Ù†Ú©ÙˆØ± Ø³Ø±Ø§Ø³Ø±ÛŒ ØªØ¬Ø±Ø¨ÛŒ</div>
      <div class="wa-name">Ù…Ù‡Ø¯ÛŒ Ø¨Ø§Ù‚Ø±ÛŒØ§Ù†</div>
      <div class="wa-title">Ø¯Ø§Ù†Ø´Ø¬ÙˆÛŒ Ù¾Ø²Ø´Ú©ÛŒ Ø¯Ø§Ù†Ø´Ú¯Ø§Ù‡ Ø¹Ù„ÙˆÙ… Ù¾Ø²Ø´Ú©ÛŒ ØªÙ‡Ø±Ø§Ù†</div>
      <div class="wa-badge">ğŸ“ Ù…Ø´Ø§ÙˆØ± ØªØ­ØµÛŒÙ„ÛŒ ØªØ®ØµØµÛŒ Ú©Ù†Ú©ÙˆØ±</div>
    </div>
    <div class="welcome-box">
      <div class="welcome-sub">Ø´Ù…Ø§ Ú©ÛŒ Ù‡Ø³ØªÛŒØ¯ØŸ</div>
      <div class="role-btns">
        <button class="role-btn advisor-btn" onclick="goToLogin('advisor')">
          <div class="rb-icon">ğŸ“</div>
          <div><div class="rb-title">Ù…Ø´Ø§ÙˆØ± Ù‡Ø³ØªÙ…</div><div class="rb-sub">Ø¯Ø³ØªØ±Ø³ÛŒ Ú©Ø§Ù…Ù„ Ø¨Ù‡ Ù‡Ù…Ù‡ Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ²Ø§Ù†</div></div>
        </button>
        <button class="role-btn student-btn" onclick="goToLogin('student')">
          <div class="rb-icon">ğŸ“–</div>
          <div><div class="rb-title">Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ² Ù‡Ø³ØªÙ…</div><div class="rb-sub">ÙˆØ±ÙˆØ¯ Ø¨Ø§ Ú©Ø¯ Ø§Ø®ØªØµØ§ØµÛŒ Ø§Ø² Ù…Ø´Ø§ÙˆØ±</div></div>
        </button>
      </div>
    </div>
  </div>
</div>

<!-- LOGIN -->
<div class="screen" id="loginScreen">
  <div class="login-box">
    <div class="login-logo" id="loginLogo">ğŸ“</div>
    <div class="login-title" id="loginTitle">ÙˆØ±ÙˆØ¯ Ù…Ø´Ø§ÙˆØ±</div>
    <div class="login-sub" id="loginSub">Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯</div>
    <input class="login-input" type="password" id="loginInput" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" onkeydown="if(event.key==='Enter')doLogin()">
    <button class="login-btn" onclick="doLogin()" id="loginBtn">ÙˆØ±ÙˆØ¯</button>
    <div class="login-err" id="loginErr"></div>
    <div class="back-link" onclick="goBack()">â† Ø¨Ø±Ú¯Ø´Øª</div>
  </div>
</div>

<!-- PROFILE SETUP -->
<div class="screen" id="profileScreen">
  <div class="profile-box">
    <div style="font-size:40px;margin-bottom:12px;text-align:center">ğŸ‘‹</div>
    <div style="text-align:center;margin-bottom:20px">
      <div class="profile-name" id="profileName">â€”</div>
      <div style="font-size:13px;color:var(--text-muted)">Ø®ÙˆØ´ Ø§ÙˆÙ…Ø¯ÛŒ!</div>
    </div>
    <div class="profile-title">ØªÚ©Ù…ÛŒÙ„ Ù¾Ø±ÙˆÙØ§ÛŒÙ„</div>
    <div class="profile-sub">Ù‚Ø¨Ù„ Ø§Ø² Ø´Ø±ÙˆØ¹ØŒ ÛŒÙ‡ Ø³Ø±ÛŒ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø§Ø²Øª Ù„Ø§Ø²Ù… Ø¯Ø§Ø±ÛŒÙ…. ÙÙ‚Ø· ÛŒÙ‡ Ø¨Ø§Ø± Ù¾Ø± Ù…ÛŒØ´Ù‡ ğŸ™‚</div>
    <div style="display:flex;flex-direction:column;gap:14px">
      <div class="form-group">
        <label>ğŸ“š Ù¾Ø§ÛŒÙ‡ ØªØ­ØµÛŒÙ„ÛŒ</label>
        <select id="profileGrade">
          <option value="">Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯</option>
          <option value="Ø¯Ù‡Ù…">Ø¯Ù‡Ù…</option>
          <option value="ÛŒØ§Ø²Ø¯Ù‡Ù…">ÛŒØ§Ø²Ø¯Ù‡Ù…</option>
          <option value="Ø¯ÙˆØ§Ø²Ø¯Ù‡Ù… ØªØ¬Ø±Ø¨ÛŒ">Ø¯ÙˆØ§Ø²Ø¯Ù‡Ù… ØªØ¬Ø±Ø¨ÛŒ</option>
          <option value="Ø¯ÙˆØ§Ø²Ø¯Ù‡Ù… Ø±ÛŒØ§Ø¶ÛŒ">Ø¯ÙˆØ§Ø²Ø¯Ù‡Ù… Ø±ÛŒØ§Ø¶ÛŒ</option>
          <option value="ÙØ§Ø±Øºâ€ŒØ§Ù„ØªØ­ØµÛŒÙ„ ØªØ¬Ø±Ø¨ÛŒ">ÙØ§Ø±Øºâ€ŒØ§Ù„ØªØ­ØµÛŒÙ„ ØªØ¬Ø±Ø¨ÛŒ (Ú©Ù†Ú©ÙˆØ±ÛŒ)</option>
          <option value="ÙØ§Ø±Øºâ€ŒØ§Ù„ØªØ­ØµÛŒÙ„ Ø±ÛŒØ§Ø¶ÛŒ">ÙØ§Ø±Øºâ€ŒØ§Ù„ØªØ­ØµÛŒÙ„ Ø±ÛŒØ§Ø¶ÛŒ (Ú©Ù†Ú©ÙˆØ±ÛŒ)</option>
        </select>
      </div>
      <div class="form-group">
        <label>ğŸ¯ Ø±Ø´ØªÙ‡ ØªØ­ØµÛŒÙ„ÛŒ</label>
        <select id="profileField">
          <option value="">Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯</option>
          <option value="ØªØ¬Ø±Ø¨ÛŒ">ØªØ¬Ø±Ø¨ÛŒ</option>
          <option value="Ø±ÛŒØ§Ø¶ÛŒ">Ø±ÛŒØ§Ø¶ÛŒ</option>
          <option value="Ø§Ù†Ø³Ø§Ù†ÛŒ">Ø§Ù†Ø³Ø§Ù†ÛŒ</option>
          <option value="Ù‡Ù†Ø±">Ù‡Ù†Ø±</option>
        </select>
      </div>
    </div>
    <button class="submit-btn" onclick="saveProfile()" style="margin-top:24px">âœ… Ø°Ø®ÛŒØ±Ù‡ Ùˆ ÙˆØ±ÙˆØ¯</button>
  </div>
</div>

<!-- ADVISOR APP -->
<div class="screen" id="advisorApp">
<header>
  <div class="logo">
    <div class="logo-icon">ğŸ“</div>
    <div><div class="logo-name">Ù…Ù‡Ø¯ÛŒ Ø¨Ø§Ù‚Ø±ÛŒØ§Ù† | Ø±ØªØ¨Ù‡ Û¶Û³</div><div class="logo-role">Ù¾Ù†Ù„ Ù…Ø´Ø§ÙˆØ± ØªØ­ØµÛŒÙ„ÛŒ</div></div>
  </div>
  <nav>
    <button class="nav-btn active" onclick="aShowPage('overview',this)">ğŸ“Š <span>Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯</span></button>
    <button class="nav-btn" onclick="aShowPage('students',this)">ğŸ‘¥ <span>Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ²Ø§Ù†</span></button>
    <button class="nav-btn" onclick="aShowPage('reports',this)">ğŸ“‹ <span>Ú¯Ø²Ø§Ø±Ø´â€ŒÙ‡Ø§</span></button>
    <button class="nav-btn" onclick="aShowPage('exams',this)">ğŸ† <span>Ø¢Ø²Ù…ÙˆÙ†â€ŒÙ‡Ø§</span></button>
    <button class="nav-btn" onclick="aShowPage('charts',this)">ğŸ“ˆ <span>Ù†Ù…ÙˆØ¯Ø§Ø±Ù‡Ø§</span></button>
  </nav>
  <button class="logout-btn" onclick="logout()">Ø®Ø±ÙˆØ¬</button>
</header>
<div class="main">

  <!-- OVERVIEW -->
  <div id="a-overview" class="page-section active">
    <div class="page-hdr"><h1>Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ ğŸ“Š</h1><p>Ù†Ù…Ø§ÛŒ Ú©Ù„ÛŒ Ø§Ø² ÙˆØ¶Ø¹ÛŒØª Ù‡Ù…Ù‡ Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ²Ø§Ù†</p></div>
    <div class="stats-row" id="aOverviewStats"></div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px">
      <div class="card"><div class="card-hdr"><div class="card-title"><div class="ibox ib-purple">ğŸ“‹</div>Ø¢Ø®Ø±ÛŒÙ† Ú¯Ø²Ø§Ø±Ø´â€ŒÙ‡Ø§</div></div><div id="aRecentReports"></div></div>
      <div class="card"><div class="card-hdr"><div class="card-title"><div class="ibox ib-gold">ğŸ†</div>Ø¢Ø®Ø±ÛŒÙ† Ø¢Ø²Ù…ÙˆÙ†â€ŒÙ‡Ø§</div></div><div id="aRecentExams"></div></div>
    </div>
  </div>

  <!-- STUDENTS -->
  <div id="a-students" class="page-section">
    <div class="page-hdr"><h1>Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ²Ø§Ù† ğŸ‘¥</h1></div>
    <div class="card">
      <div class="card-hdr"><div class="card-title"><div class="ibox ib-purple">â•</div>Ø§ÙØ²ÙˆØ¯Ù† Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ² Ø¬Ø¯ÛŒØ¯</div></div>
      <div class="form-grid" style="margin-bottom:12px">
        <div class="form-group"><label>Ù†Ø§Ù… Ú©Ø§Ù…Ù„</label><input type="text" id="newSName" placeholder="Ù…Ø«Ù„Ø§Ù‹: Ø¹Ù„ÛŒ Ø§Ø­Ù…Ø¯ÛŒ"></div>
        <div class="form-group"><label>Ú©Ø¯ Ø¯Ø³ØªØ±Ø³ÛŒ</label><input type="text" id="newSCode" placeholder="Ù…Ø«Ù„Ø§Ù‹: ALI2024" style="direction:ltr;letter-spacing:2px"></div>
        <div class="form-group"><label>Ù¾Ø§ÛŒÙ‡ ØªØ­ØµÛŒÙ„ÛŒ</label>
          <select id="newSGrade">
            <option value="Ø¯Ù‡Ù…">Ø¯Ù‡Ù…</option><option value="ÛŒØ§Ø²Ø¯Ù‡Ù…">ÛŒØ§Ø²Ø¯Ù‡Ù…</option>
            <option value="Ø¯ÙˆØ§Ø²Ø¯Ù‡Ù… ØªØ¬Ø±Ø¨ÛŒ">Ø¯ÙˆØ§Ø²Ø¯Ù‡Ù… ØªØ¬Ø±Ø¨ÛŒ</option><option value="Ø¯ÙˆØ§Ø²Ø¯Ù‡Ù… Ø±ÛŒØ§Ø¶ÛŒ">Ø¯ÙˆØ§Ø²Ø¯Ù‡Ù… Ø±ÛŒØ§Ø¶ÛŒ</option>
            <option value="ÙØ§Ø±Øºâ€ŒØ§Ù„ØªØ­ØµÛŒÙ„">ÙØ§Ø±Øºâ€ŒØ§Ù„ØªØ­ØµÛŒÙ„ (Ú©Ù†Ú©ÙˆØ±ÛŒ)</option>
          </select>
        </div>
        <div class="form-group"><label>Ø±Ø´ØªÙ‡ ØªØ­ØµÛŒÙ„ÛŒ</label>
          <select id="newSField">
            <option value="ØªØ¬Ø±Ø¨ÛŒ">ØªØ¬Ø±Ø¨ÛŒ</option><option value="Ø±ÛŒØ§Ø¶ÛŒ">Ø±ÛŒØ§Ø¶ÛŒ</option>
            <option value="Ø§Ù†Ø³Ø§Ù†ÛŒ">Ø§Ù†Ø³Ø§Ù†ÛŒ</option><option value="Ù‡Ù†Ø±">Ù‡Ù†Ø±</option>
          </select>
        </div>
        <div class="form-group"><label>ğŸ“… ØªØ§Ø±ÛŒØ® Ø§Ù†Ù‚Ø¶Ø§ÛŒ Ø§Ø´ØªØ±Ø§Ú© (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)</label><input type="date" id="newSSubUntil" placeholder="ØªØ§Ø±ÛŒØ® Ù…ÛŒÙ„Ø§Ø¯ÛŒ"></div>
      </div>
      <div style="display:flex;gap:9px">
        <button class="btn btn-outline" onclick="genCode()">ğŸ”€ Ú©Ø¯ ØªØµØ§Ø¯ÙÛŒ</button>
        <button class="btn btn-success" onclick="addStudent()">âœ… Ø«Ø¨Øª Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ²</button>
      </div>
    </div>
    <div class="card"><div class="card-hdr"><div class="card-title"><div class="ibox ib-cyan">ğŸ‘¥</div>Ù„ÛŒØ³Øª Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ²Ø§Ù†</div></div><div class="students-grid" id="aStudentsList"></div></div>
  </div>

  <!-- REPORTS -->
  <div id="a-reports" class="page-section">
    <div class="page-hdr"><h1>Ú¯Ø²Ø§Ø±Ø´â€ŒÙ‡Ø§ÛŒ Ø±ÙˆØ²Ø§Ù†Ù‡ ğŸ“‹</h1></div>
    <div class="card">
      <div class="form-grid">
        <div class="form-group"><label>Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ²</label><select id="aFilterStudent" onchange="aRenderReports()"><option value="">Ù‡Ù…Ù‡</option></select></div>
        <div class="form-group"><label>Ø§Ø² ØªØ§Ø±ÛŒØ®</label><input type="date" id="aFilterDate" onchange="aRenderReports()"></div>
      </div>
    </div>
    <div id="aReportsList"></div>
  </div>

  <!-- EXAMS (advisor sees student-submitted exams) -->
  <div id="a-exams" class="page-section">
    <div class="page-hdr"><h1>Ù†ØªØ§ÛŒØ¬ Ø¢Ø²Ù…ÙˆÙ†â€ŒÙ‡Ø§ ğŸ†</h1><p>Ù†ØªØ§ÛŒØ¬ Ø«Ø¨Øªâ€ŒØ´Ø¯Ù‡ ØªÙˆØ³Ø· Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ²Ø§Ù†</p></div>
    <div class="card">
      <div class="card-hdr">
        <div class="card-title"><div class="ibox ib-gold">ğŸ“‹</div>Ø¢Ø²Ù…ÙˆÙ†â€ŒÙ‡Ø§ÛŒ Ø«Ø¨Øªâ€ŒØ´Ø¯Ù‡</div>
        <select id="aFilterExamSt" onchange="aRenderExams()" style="padding:5px 9px;font-size:11px;border-radius:7px;width:auto"><option value="">Ù‡Ù…Ù‡</option></select>
      </div>
      <div id="aExamsList"></div>
    </div>
  </div>

  <!-- CHARTS -->
  <div id="a-charts" class="page-section">
    <div class="page-hdr"><h1>Ù†Ù…ÙˆØ¯Ø§Ø± Ù¾ÛŒØ´Ø±ÙØª ğŸ“ˆ</h1></div>
    <div class="card" style="margin-bottom:16px"><div class="form-group" style="max-width:260px"><label>Ø§Ù†ØªØ®Ø§Ø¨ Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ²</label><select id="aChartSt" onchange="aRenderCharts()"><option value="">Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯</option></select></div></div>
    <div id="aChartsArea"></div>
  </div>

</div>
</div>

<!-- ======= STUDENT APP ======= -->
<div class="screen" id="studentApp">
<header>
  <div class="logo">
    <div class="logo-icon" id="sLogoIcon" style="font-size:14px;font-weight:900">?</div>
    <div><div class="logo-name" id="sHeaderName">â€”</div><div class="logo-role" id="sHeaderGrade">â€”</div></div>
  </div>
  <nav>
    <button class="nav-btn active" onclick="sShowPage('home',this)">ğŸ  <span>Ø®Ø§Ù†Ù‡</span></button>
    <button class="nav-btn" onclick="sShowPage('report',this)">ğŸ“ <span>Ú¯Ø²Ø§Ø±Ø´</span></button>
    <button class="nav-btn" onclick="sShowPage('history',this)">ğŸ“‹ <span>ØªØ§Ø±ÛŒØ®Ú†Ù‡</span></button>
    <button class="nav-btn" onclick="sShowPage('exams',this)">ğŸ† <span>Ø¢Ø²Ù…ÙˆÙ†â€ŒÙ‡Ø§</span></button>
    <button class="nav-btn" onclick="sShowPage('progress',this)">ğŸ“ˆ <span>Ù¾ÛŒØ´Ø±ÙØª</span></button>
  </nav>
  <button class="logout-btn" onclick="logout()">Ø®Ø±ÙˆØ¬</button>
</header>
<div class="main">

  <!-- HOME -->
  <div id="s-home" class="page-section active">
    <div class="student-hero">
      <div class="sh-name" id="shName">â€”</div>
      <div class="sh-info">
        <span id="shGrade">â€”</span>
        <span id="shField">â€”</span>
      </div>
      <div class="countdown-grid">
        <div class="countdown-box cd-tajrobi">
          <div class="cd-label">â³ Ú©Ù†Ú©ÙˆØ± ØªØ¬Ø±Ø¨ÛŒ</div>
          <div class="cd-days" id="cdTajrobi">â€”</div>
          <div class="cd-unit">Ø±ÙˆØ² Ù…Ø§Ù†Ø¯Ù‡</div>
          <div class="cd-exp" style="color:var(--success)" id="cdTajrobiDate"></div>
        </div>
        <div class="countdown-box cd-riazi">
          <div class="cd-label">ğŸ“ Ú©Ù†Ú©ÙˆØ± Ø±ÛŒØ§Ø¶ÛŒ</div>
          <div class="cd-days" id="cdRiazi">â€”</div>
          <div class="cd-unit">Ø±ÙˆØ² Ù…Ø§Ù†Ø¯Ù‡</div>
          <div class="cd-exp" style="color:var(--blue)" id="cdRiaziDate"></div>
        </div>
      </div>
      <div id="subStatusBox"></div>
    </div>

    <div id="sStreakBox" class="streak-card"></div>

    <div class="card">
      <div class="card-title" style="margin-bottom:14px"><div class="ibox ib-purple">ğŸ“Š</div>Ø®Ù„Ø§ØµÙ‡ Ø§ÛŒÙ† Ù‡ÙØªÙ‡</div>
      <div class="stats-row" id="sWeekStats" style="grid-template-columns:repeat(3,1fr)"></div>
    </div>
  </div>

  <!-- REPORT -->
  <div id="s-report" class="page-section">
    <div id="sQuote" style="background:linear-gradient(135deg,rgba(124,58,237,0.08),rgba(6,182,212,0.06));border:1px solid rgba(124,58,237,0.2);border-radius:13px;padding:14px 18px;text-align:center;margin-bottom:14px;font-size:13px;color:var(--text-dim);line-height:1.7"></div>
    <div class="card">
      <div class="card-title" style="margin-bottom:14px"><div class="ibox ib-cyan">ğŸ“…</div>Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø±ÙˆØ²</div>
      <div class="form-grid">
        <div class="form-group">
          <label>ØªØ§Ø±ÛŒØ® Ø§Ù…Ø±ÙˆØ²</label>
          <div style="background:var(--surface2);border:1px solid var(--border2);border-radius:9px;padding:10px 13px;font-size:13px;color:var(--accent2);font-weight:700" id="sDateDisplay">â€”</div>
          <input type="hidden" id="sDate">
        </div>
        <div class="form-group"><label>ÙˆØ¶Ø¹ÛŒØª Ú©Ù„ÛŒ Ø±ÙˆØ²</label><select id="sMood"><option value="great">ğŸ”¥ Ø®ÛŒÙ„ÛŒ Ø®ÙˆØ¨</option><option value="good" selected>ğŸ˜Š Ø®ÙˆØ¨</option><option value="ok">ğŸ˜ Ù…Ø¹Ù…ÙˆÙ„ÛŒ</option><option value="bad">ğŸ˜ Ø¨Ø¯</option></select></div>
      </div>
    </div>
    <div class="card">
      <div class="card-title" style="margin-bottom:14px"><div class="ibox ib-purple">ğŸ“–</div>Ø¯Ø±Ø³â€ŒÙ‡Ø§ÛŒ Ø§Ù…Ø±ÙˆØ²</div>
      <div class="lessons-container" id="sLessonsContainer"></div>
      <button class="add-btn" onclick="sAddLesson()">ï¼‹ Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ø¯Ø±Ø³</button>
    </div>
    <div class="card">
      <div class="card-title" style="margin-bottom:14px"><div class="ibox ib-green">ğŸ“Š</div>Ø®Ù„Ø§ØµÙ‡ Ø±ÙˆØ²</div>
      <div class="sum-row">
        <div class="sum-card"><div class="sum-val c-purple" id="sSumH">Û°:Û°Û°</div><div class="sum-lbl">Ù…Ø¬Ù…ÙˆØ¹ Ù…Ø·Ø§Ù„Ø¹Ù‡</div></div>
        <div class="sum-card"><div class="sum-val c-cyan" id="sSumT">Û°</div><div class="sum-lbl">Ù…Ø¬Ù…ÙˆØ¹ ØªØ³Øª</div></div>
        <div class="sum-card"><div class="sum-val c-green" id="sSumP">â€”</div><div class="sum-lbl">Ù…ÛŒØ§Ù†Ú¯ÛŒÙ† Ø¯Ø±ØµØ¯</div></div>
      </div>
    </div>
    <div class="card">
      <div class="card-title" style="margin-bottom:14px"><div class="ibox ib-gold">ğŸ˜Š</div>Ø±Ø¶Ø§ÛŒØª Ø§Ø² Ø§Ù…Ø±ÙˆØ²</div>
      <div class="sat-row"><div><div class="sat-num" id="sSatV">Û·Û°Ùª</div><div style="font-size:10px;color:var(--text-muted)">Ø¯Ø±ØµØ¯ Ø±Ø¶Ø§ÛŒØª</div></div><div class="sat-emoji" id="sSatE">ğŸ˜Š</div></div>
      <input type="range" id="sSatS" min="0" max="100" value="70" oninput="sUpdateSat(this.value)">
      <div style="display:flex;justify-content:space-between;margin-top:5px;font-size:10px;color:var(--text-muted)"><span>ğŸ˜</span><span>ğŸ˜</span><span>ğŸ¤©</span></div>
    </div>
    <div class="card">
      <div class="card-title" style="margin-bottom:14px"><div class="ibox ib-pink">ğŸ’¬</div>ÛŒØ§Ø¯Ø¯Ø§Ø´Øª Ú©Ù„ÛŒ Ø±ÙˆØ²</div>
      <textarea id="sNotes" rows="3" placeholder="Ø§Ù…Ø±ÙˆØ² Ú†Ù‡ Ø§Ø­Ø³Ø§Ø³ÛŒ Ø¯Ø§Ø´ØªÛŒØŸ Ú†ÛŒ Ø³Ø®Øª Ø¨ÙˆØ¯ØŸ Ù‡Ø¯Ù ÙØ±Ø¯Ø§Øª Ú†ÛŒÙ‡ØŸ"></textarea>
    </div>
    <button class="submit-btn" id="sSubmitBtn" onclick="sSubmitReport()">âœ… Ø«Ø¨Øª Ú¯Ø²Ø§Ø±Ø´ Ø§Ù…Ø±ÙˆØ²</button>
  </div>

  <!-- HISTORY -->
  <div id="s-history" class="page-section">
    <div class="page-hdr"><h1>ØªØ§Ø±ÛŒØ®Ú†Ù‡ Ú¯Ø²Ø§Ø±Ø´â€ŒÙ‡Ø§ ğŸ“‹</h1></div>
    <div id="sHistoryList"></div>
  </div>

  <!-- EXAMS (student submits own exams) -->
  <div id="s-exams" class="page-section">
    <div class="page-hdr"><h1>Ù†ØªØ§ÛŒØ¬ Ø¢Ø²Ù…ÙˆÙ†â€ŒÙ‡Ø§ ğŸ†</h1></div>
    <div class="card">
      <div class="card-hdr"><div class="card-title"><div class="ibox ib-gold">â•</div>Ø«Ø¨Øª Ù†ØªÛŒØ¬Ù‡ Ø¢Ø²Ù…ÙˆÙ† Ø¬Ø¯ÛŒØ¯</div></div>
      <div class="form-grid" style="margin-bottom:12px">
        <div class="form-group"><label>Ù†Ø§Ù… Ø¢Ø²Ù…ÙˆÙ†</label><input type="text" id="sExamName" placeholder="Ù…Ø«Ù„Ø§Ù‹: Ú¯Ø²ÛŒÙ†Ù‡ Ø¯Ùˆ â€” Ù…Ø±Ø­Ù„Ù‡ Û³"></div>
        <div class="form-group"><label>Ù†ÙˆØ¹ Ø¢Ø²Ù…ÙˆÙ†</label><select id="sExamType"><option>Ø¢Ø²Ù…Ø§ÛŒØ´ÛŒ</option><option>Ø¬Ø§Ù…Ø¹</option><option>Ù¾ÛŒØ´Ø±ÙØªâ€ŒÙ…Ø­ÙˆØ±</option><option>Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø² Ú©Ù†Ú©ÙˆØ±</option><option>Ù…Ø±Ø­Ù„Ù‡â€ŒØ§ÛŒ</option></select></div>
        <div class="form-group"><label>ØªØ§Ø±ÛŒØ® Ø¢Ø²Ù…ÙˆÙ†</label>
          <div style="background:var(--surface2);border:1px solid var(--border2);border-radius:9px;padding:10px 13px;font-size:13px;color:var(--accent2);font-weight:700" id="sExamDateDisplay">â€”</div>
          <input type="hidden" id="sExamDate">
        </div>
        <div class="form-group"><label>ØªØ±Ø§Ø²</label><input type="number" id="sExamTaraz" placeholder="Ù…Ø«Ù„Ø§Ù‹: 6840"></div>
        <div class="form-group"><label>Ø±ØªØ¨Ù‡ Ø¯Ø± Ø¢Ø²Ù…ÙˆÙ†</label><input type="number" id="sExamRank" placeholder="Ù…Ø«Ù„Ø§Ù‹: 125"></div>
      </div>
      <div style="margin-bottom:12px">
        <div style="font-size:11px;font-weight:700;color:var(--text-dim);margin-bottom:9px">Ø¯Ø±ØµØ¯ Ù‡Ø± Ø¯Ø±Ø³</div>
        <div class="form-grid" id="sExamSubjGrid"></div>
      </div>
      <button class="btn btn-primary" id="sExamSubmitBtn" onclick="sAddExam()">âœ… Ø«Ø¨Øª Ù†ØªÛŒØ¬Ù‡</button>
    </div>
    <div class="card">
      <div class="card-hdr"><div class="card-title"><div class="ibox ib-gold">ğŸ“‹</div>Ø¢Ø²Ù…ÙˆÙ†â€ŒÙ‡Ø§ÛŒ Ù‚Ø¨Ù„ÛŒ</div></div>
      <div id="sExamsList"></div>
    </div>
  </div>

  <!-- PROGRESS -->
  <div id="s-progress" class="page-section">
    <div class="page-hdr"><h1>Ù¾ÛŒØ´Ø±ÙØª Ù…Ù† ğŸ“ˆ</h1></div>
    <div id="sProgressArea"></div>
  </div>

</div>
</div>

<!-- MODALS -->
<div class="modal-overlay" id="reportModal"><div class="modal"><div class="modal-hdr"><div class="modal-title" id="rMTitle"></div><button class="close-btn" onclick="closeModal('reportModal')">âœ•</button></div><div id="rMContent"></div></div></div>
<div class="modal-overlay" id="examModal"><div class="modal"><div class="modal-hdr"><div class="modal-title" id="eMTitle"></div><button class="close-btn" onclick="closeModal('examModal')">âœ•</button></div><div id="eMContent"></div></div></div>
<div class="modal-overlay" id="studentModal"><div class="modal"><div class="modal-hdr"><div class="modal-title" id="stMTitle"></div><button class="close-btn" onclick="closeModal('studentModal')">âœ•</button></div><div id="stMContent"></div></div></div>

<div class="toast" id="toast"></div>

<script>
// ===== CONFIG =====
const SUPABASE_URL='https://ngvgtwbkkqalmzvnscns.supabase.co';
const SUPABASE_KEY='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5ndmd0d2Jra3FhbG16dm5zY25zIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzIyMDgzMjMsImV4cCI6MjA4Nzc4NDMyM30.N8MtsytKHNivrMjp1w9I_pfdy1bUYblz3rezRtkQkRM';
const ADVISOR_PASSWORD='mahdi1234';
const SUBJECTS_TAJROBI=['Ø²ÛŒØ³Øªâ€ŒØ´Ù†Ø§Ø³ÛŒ','ÙÛŒØ²ÛŒÚ©','Ø´ÛŒÙ…ÛŒ','Ø±ÛŒØ§Ø¶ÛŒ','Ø²Ù…ÛŒÙ†â€ŒØ´Ù†Ø§Ø³ÛŒ','Ø§Ø¯Ø¨ÛŒØ§Øª','Ø¯ÛŒÙ† Ùˆ Ø²Ù†Ø¯Ú¯ÛŒ','Ø¹Ø±Ø¨ÛŒ','Ø²Ø¨Ø§Ù† Ø§Ù†Ú¯Ù„ÛŒØ³ÛŒ'];
const SUBJECTS_RIAZI=['Ø­Ø³Ø§Ø¨Ø§Ù†','Ú¯Ø³Ø³ØªÙ‡','Ù‡Ù†Ø¯Ø³Ù‡','Ø¢Ù…Ø§Ø± Ùˆ Ø§Ø­ØªÙ…Ø§Ù„','ÙÛŒØ²ÛŒÚ©','Ø´ÛŒÙ…ÛŒ','Ø§Ø¯Ø¨ÛŒØ§Øª','Ø¯ÛŒÙ† Ùˆ Ø²Ù†Ø¯Ú¯ÛŒ','Ø¹Ø±Ø¨ÛŒ','Ø²Ø¨Ø§Ù† Ø§Ù†Ú¯Ù„ÛŒØ³ÛŒ'];
const SUBJECTS_DEFAULT=['Ø§Ø¯Ø¨ÛŒØ§Øª','Ø¯ÛŒÙ† Ùˆ Ø²Ù†Ø¯Ú¯ÛŒ','Ø¹Ø±Ø¨ÛŒ','Ø²Ø¨Ø§Ù† Ø§Ù†Ú¯Ù„ÛŒØ³ÛŒ','Ø±ÛŒØ§Ø¶ÛŒ','ÙÛŒØ²ÛŒÚ©','Ø´ÛŒÙ…ÛŒ'];
function getSubjects(field){
  if(!field)return SUBJECTS_DEFAULT;
  if(field==='ØªØ¬Ø±Ø¨ÛŒ'||field.includes('ØªØ¬Ø±Ø¨ÛŒ'))return SUBJECTS_TAJROBI;
  if(field==='Ø±ÛŒØ§Ø¶ÛŒ'||field.includes('Ø±ÛŒØ§Ø¶ÛŒ'))return SUBJECTS_RIAZI;
  return SUBJECTS_DEFAULT;
}
const QUOTES=['Ù‡Ø± Ø±ÙˆØ² ÛŒÙ‡ Ù‚Ø¯Ù… Ø¨Ù‡ Ø±ÙˆÛŒØ§Øª Ù†Ø²Ø¯ÛŒÚ©â€ŒØªØ± Ù…ÛŒØ´ÛŒ ğŸŒŸ','Ù…Ø¯Ø§ÙˆÙ…Øª Ú©Ù„ÛŒØ¯ Ù…ÙˆÙÙ‚ÛŒØªÙ‡. Ø§Ù…Ø±ÙˆØ² Ù‡Ù… Ø¨Ø¯Ø±Ø®Ø´ âœ¨','Ú©Ù†Ú©ÙˆØ± Ø¯Ø§Ø±Ù‡ Ù†Ø²Ø¯ÛŒÚ© Ù…ÛŒØ´Ù‡. Ø§ÛŒÙ† Ù„Ø­Ø¸Ø§Øª Ø·Ù„Ø§ÛŒÛŒÙ‡ ğŸ†','Ù‡Ø± ØªØ³ØªÛŒ Ú©Ù‡ Ù…ÛŒØ²Ù†ÛŒ ÛŒÙ‡ Ø³Ù†Ú¯ Ø±Ùˆ Ø¬Ø§Ø¯Ù‡ Ù¾ÛŒØ´Ø±ÙØªÙ‡ ğŸª¨','Ø±ØªØ¨Ù‡ Û¶Û³ Ù…Ù‡Ø¯ÛŒ Ù†Ø´ÙˆÙ† Ø¯Ø§Ø¯ Ú©Ù‡ Ø¨Ø§ Ø¨Ø±Ù†Ø§Ù…Ù‡ Ù‡Ù…Ù‡ Ú†ÛŒØ² Ù…Ù…Ú©Ù†Ù‡ ğŸ’ª','Ø§Ù…Ø±ÙˆØ² Ø³Ø®Øª Ø¨Ø®ÙˆÙ†ØŒ ÙØ±Ø¯Ø§ Ø±Ø§Ø­Øª Ø¨Ø®ÙˆØ§Ø¨ ğŸ˜´','ØªÙˆ Ù„Ø§ÛŒÙ‚ Ø¨Ù‡ØªØ±ÛŒÙ†ÛŒØŒ ÙÙ‚Ø· Ø§Ø¯Ø§Ù…Ù‡ Ø¨Ø¯Ù‡ ğŸ’œ'];

const {createClient}=supabase;
const db=createClient(SUPABASE_URL,SUPABASE_KEY);

let currentRole=null,currentStudent=null,sLessonCount=0;
let cachedStudents=[],cachedReports=[],cachedExams=[];

// ===== JALALI (Shamsi) helpers =====
function toJalali(gy,gm,gd){
  const g_d_no=[0,31,59,90,120,151,181,212,243,273,304,334];
  let jy,jm,jd,g_y,g_y2,days;
  gy=parseInt(gy);gm=parseInt(gm);gd=parseInt(gd);
  g_y=gy-1600;gm=gm-1;gd=gd-1;
  let g_day_no=365*g_y+Math.floor((g_y+3)/4)-Math.floor((g_y+99)/100)+Math.floor((g_y+399)/400);
  for(let i=0;i<gm;i++)g_day_no+=g_d_no[i];
  if(gm>1&&((gy%4==0&&gy%100!=0)||(gy%400==0)))g_day_no++;
  g_day_no+=gd;
  let j_day_no=g_day_no-79;
  let j_np=Math.floor(j_day_no/12053);j_day_no%=12053;
  jy=979+33*j_np+4*Math.floor(j_day_no/1461);
  j_day_no%=1461;
  if(j_day_no>=366){jy+=Math.floor((j_day_no-1)/365);j_day_no=(j_day_no-1)%365;}
  const j_days_in_month=[31,31,31,31,31,31,30,30,30,30,30,29];
  for(let i=0;i<11&&j_day_no>=j_days_in_month[i];i++){j_day_no-=j_days_in_month[i];jm=i+1;}
  jm=jm||0;jd=j_day_no+1;
  return{y:jy,m:jm+1,d:jd};
}

function todayJalali(){
  const n=new Date();
  return toJalali(n.getFullYear(),n.getMonth()+1,n.getDate());
}

function jalaliToGregorian(jy,jm,jd){
  jy=parseInt(jy);jm=parseInt(jm);jd=parseInt(jd);
  let gy,gm,gd;
  let jy2=jy-979,jm2=jm-1,jd2=jd-1;
  let j_day_no=365*jy2+Math.floor(jy2/33)*8+Math.floor((jy2%33+3)/4);
  for(let i=0;i<jm2;i++)j_day_no+=[31,31,31,31,31,31,30,30,30,30,30,29][i];
  j_day_no+=jd2;
  let g_day_no=j_day_no+79;
  let gy2=1600+400*Math.floor(g_day_no/146097);g_day_no=g_day_no%146097;
  let leap=true;
  if(g_day_no>=36525){g_day_no--;gy2+=100*Math.floor(g_day_no/36524);g_day_no=g_day_no%36524;if(g_day_no>=365)g_day_no++;else leap=false;}
  gy2+=4*Math.floor(g_day_no/1461);g_day_no%=1461;
  if(g_day_no>=366){leap=false;g_day_no--;gy2+=Math.floor(g_day_no/365);g_day_no=g_day_no%365;}
  const g_days_in_month=[31,28+leap,31,30,31,30,31,31,30,31,30,31];
  let gm2;
  for(gm2=0;gm2<11&&g_day_no>=g_days_in_month[gm2];gm2++)g_day_no-=g_days_in_month[gm2];
  gy=gy2;gm=gm2+1;gd=g_day_no+1;
  return{y:gy,m:gm,d:gd};
}

function jalaliStr(jy,jm,jd){
  const mn=['ÙØ±ÙˆØ±Ø¯ÛŒÙ†','Ø§Ø±Ø¯ÛŒØ¨Ù‡Ø´Øª','Ø®Ø±Ø¯Ø§Ø¯','ØªÛŒØ±','Ù…Ø±Ø¯Ø§Ø¯','Ø´Ù‡Ø±ÛŒÙˆØ±','Ù…Ù‡Ø±','Ø¢Ø¨Ø§Ù†','Ø¢Ø°Ø±','Ø¯ÛŒ','Ø¨Ù‡Ù…Ù†','Ø§Ø³ÙÙ†Ø¯'];
  return`${toPNum(jd)} ${mn[jm-1]} ${toPNum(jy)}`;
}

function gregorianToJalaliStr(dateStr){
  if(!dateStr)return'';
  const[y,m,d]=dateStr.split('-');
  const j=toJalali(y,m,d);
  return jalaliStr(j.y,j.m,j.d);
}

// ØªØ§Ø±ÛŒØ® Ú©Ù†Ú©ÙˆØ± Û±Û´Û°Ûµ â€” Û±Û² ØªÛŒØ± ØªØ¬Ø±Ø¨ÛŒØŒ Û±Û± ØªÛŒØ± Ø±ÛŒØ§Ø¶ÛŒ
// ØªØ¨Ø¯ÛŒÙ„ Ø´Ù…Ø³ÛŒ Ø¨Ù‡ Ù…ÛŒÙ„Ø§Ø¯ÛŒ: Û±Û± ØªÛŒØ± Û±Û´Û°Ûµ = 2026-07-02 ØŒ Û±Û² ØªÛŒØ± Û±Û´Û°Ûµ = 2026-07-03
const TAJROBI_DATE=new Date('2026-07-03'); // Û±Û² ØªÛŒØ± Û±Û´Û°Ûµ
const RIAZI_DATE=new Date('2026-07-02');   // Û±Û± ØªÛŒØ± Û±Û´Û°Ûµ

function daysUntil(targetDate){
  const now=new Date();
  now.setHours(0,0,0,0);
  const diff=Math.ceil((targetDate-now)/(1000*60*60*24));
  return diff;
}

// ===== SCREENS =====
function showScreen(id){document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));document.getElementById(id).classList.add('active');}
function goToLogin(role){
  currentRole=role;
  if(role==='advisor'){document.getElementById('loginLogo').textContent='ğŸ“';document.getElementById('loginTitle').textContent='ÙˆØ±ÙˆØ¯ Ù…Ø´Ø§ÙˆØ±';document.getElementById('loginSub').textContent='Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯';document.getElementById('loginInput').type='password';document.getElementById('loginInput').placeholder='â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢';document.getElementById('loginInput').style.letterSpacing='4px';}
  else{document.getElementById('loginLogo').textContent='ğŸ“–';document.getElementById('loginTitle').textContent='ÙˆØ±ÙˆØ¯ Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ²';document.getElementById('loginSub').textContent='Ú©Ø¯ Ø§Ø®ØªØµØ§ØµÛŒâ€ŒØ§Øª Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†';document.getElementById('loginInput').type='text';document.getElementById('loginInput').placeholder='XXXXXX';document.getElementById('loginInput').style.letterSpacing='6px';}
  document.getElementById('loginInput').value='';document.getElementById('loginErr').style.display='none';
  showScreen('loginScreen');setTimeout(()=>document.getElementById('loginInput').focus(),300);
}
function goBack(){showScreen('welcomeScreen');}

async function doLogin(){
  const val=document.getElementById('loginInput').value.trim();
  const btn=document.getElementById('loginBtn');
  btn.disabled=true;btn.textContent='Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø±Ø±Ø³ÛŒ...';
  document.getElementById('loginErr').style.display='none';
  if(currentRole==='advisor'){
    if(val===ADVISOR_PASSWORD){showScreen('advisorApp');await initAdvisorApp();}
    else{document.getElementById('loginErr').textContent='Ø±Ù…Ø² Ø§Ø´ØªØ¨Ø§Ù‡ Ø§Ø³Øª!';document.getElementById('loginErr').style.display='block';}
  } else {
    const{data}=await db.from('students').select('*');
    cachedStudents=data||[];
    const student=cachedStudents.find(s=>s.code===val.toUpperCase());
    if(student){
      currentStudent=student;
      // Ø§Ú¯Ù‡ Ù¾Ø±ÙˆÙØ§ÛŒÙ„ Ú©Ø§Ù…Ù„ Ù†Ø´Ø¯Ù‡ØŒ Ù†Ø´ÙˆÙ† Ø¨Ø¯Ù‡
      if(!student.grade||!student.field){
        document.getElementById('profileName').textContent=student.name;
        showScreen('profileScreen');
      } else {
        showScreen('studentApp');await initStudentApp();
      }
    }
    else{document.getElementById('loginErr').textContent='Ú©Ø¯ Ø§Ø´ØªØ¨Ø§Ù‡Ù‡! Ø§Ø² Ù…Ø´Ø§ÙˆØ±Øª Ø¨Ø®ÙˆØ§Ù‡ Ú©Ø¯Øª Ø±Ùˆ Ø¨Ø¯Ù‡';document.getElementById('loginErr').style.display='block';}
  }
  btn.disabled=false;btn.textContent='ÙˆØ±ÙˆØ¯';
}

function logout(){currentStudent=null;currentRole=null;showScreen('welcomeScreen');}

async function saveProfile(){
  const grade=document.getElementById('profileGrade').value;
  const field=document.getElementById('profileField').value;
  if(!grade||!field){showToast('Ù¾Ø§ÛŒÙ‡ Ùˆ Ø±Ø´ØªÙ‡ Ø±Ùˆ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†','warn');return;}
  showLoading('Ø¯Ø± Ø­Ø§Ù„ Ø°Ø®ÛŒØ±Ù‡...');
  const{error}=await db.from('students').update({grade,field}).eq('code',currentStudent.code);
  if(error){hideLoading();showToast('Ø®Ø·Ø§: '+error.message,'warn');return;}
  currentStudent={...currentStudent,grade,field};
  hideLoading();
  showScreen('studentApp');
  await initStudentApp();
}
function showLoading(t='Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ...'){document.getElementById('loadingText').textContent=t;document.getElementById('loadingOverlay').classList.add('show');}
function hideLoading(){document.getElementById('loadingOverlay').classList.remove('show');}

// ===== ADVISOR =====
async function initAdvisorApp(){
  showLoading('Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§...');
  document.getElementById('examDate')&&(document.getElementById('examDate').valueAsDate=new Date());
  await refreshAll();hideLoading();
}

async function refreshAll(){
  const[s,r,e]=await Promise.all([
    db.from('students').select('*').order('created_at',{ascending:false}),
    db.from('reports').select('*').order('created_at',{ascending:false}),
    db.from('exams').select('*').order('created_at',{ascending:false})
  ]);
  cachedStudents=s.data||[];cachedReports=r.data||[];cachedExams=e.data||[];
  aRenderAll();
}

function aShowPage(name,btn){
  document.querySelectorAll('#advisorApp .page-section').forEach(s=>s.classList.remove('active'));
  document.querySelectorAll('#advisorApp .nav-btn').forEach(b=>b.classList.remove('active'));
  document.getElementById('a-'+name).classList.add('active');
  if(btn)btn.classList.add('active');
  if(name==='charts')aRenderCharts();
}

function aRenderAll(){
  aRenderOverview();aRenderStudents();aUpdateSelects();aRenderReports();aRenderExams();
}

function aRenderOverview(){
  const s=cachedStudents,r=cachedReports,e=cachedExams;
  const expiredCount=s.filter(x=>isSubExpired(x)).length;
  document.getElementById('aOverviewStats').innerHTML=`
    <div class="stat-card"><div class="stat-num c-purple">${toPNum(s.length)}</div><div class="stat-lbl">Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ²</div></div>
    <div class="stat-card"><div class="stat-num c-cyan">${toPNum(r.length)}</div><div class="stat-lbl">Ú¯Ø²Ø§Ø±Ø´</div></div>
    <div class="stat-card"><div class="stat-num c-gold">${toPNum(e.length)}</div><div class="stat-lbl">Ø¢Ø²Ù…ÙˆÙ†</div></div>
    <div class="stat-card" style="${expiredCount>0?'border-color:rgba(239,68,68,0.4)':''}"><div class="stat-num" style="color:${expiredCount>0?'var(--danger)':'var(--success)'}">${toPNum(expiredCount)}</div><div class="stat-lbl">Ø§Ø´ØªØ±Ø§Ú© Ù…Ù†Ù‚Ø¶ÛŒ</div></div>`;
  const rr=[...r].slice(0,5);
  document.getElementById('aRecentReports').innerHTML=rr.length?rr.map(x=>`<div class="report-row" onclick="openReportModal('${x.id}')"><div style="font-weight:700;font-size:13px;min-width:70px">${x.student_name}</div><div style="font-size:11px;color:var(--text-muted)">${gregorianToJalaliStr(x.date)}</div><div style="font-size:11px;color:var(--text-dim)">${toPNum(Math.floor(x.total_mins/60))}:${String(x.total_mins%60).padStart(2,'0')}</div>${satBadge(x.satisfaction)}</div>`).join(''):'<div class="empty"><div class="empty-icon">ğŸ“­</div>Ú¯Ø²Ø§Ø±Ø´ÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡</div>';
  const re=[...e].slice(0,5);
  document.getElementById('aRecentExams').innerHTML=re.length?re.map(x=>`<div class="report-row" onclick="openExamModal('${x.id}')"><div><div style="font-weight:700;font-size:13px">${x.student_name}</div><div style="font-size:11px;color:var(--text-muted)">${x.exam_name}</div></div>${x.taraz?`<span class="badge bg-purple">ØªØ±Ø§Ø² ${toPNum(x.taraz)}</span>`:''}</div>`).join(''):'<div class="empty"><div class="empty-icon">ğŸ†</div>Ø¢Ø²Ù…ÙˆÙ†ÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡</div>';
}

// Subscription helpers
function isSubExpired(student){
  if(!student.sub_until)return true;
  const until=new Date(student.sub_until);until.setHours(23,59,59);
  return new Date()>until;
}
function subDaysLeft(student){
  if(!student.sub_until)return-999;
  const until=new Date(student.sub_until);until.setHours(23,59,59);
  return Math.ceil((until-new Date())/(1000*60*60*24));
}

function genCode(){const c='ABCDEFGHJKLMNPQRSTUVWXYZ23456789';let code='';for(let i=0;i<6;i++)code+=c[Math.floor(Math.random()*c.length)];document.getElementById('newSCode').value=code;}

async function addStudent(){
  const name=document.getElementById('newSName').value.trim();
  const code=document.getElementById('newSCode').value.trim().toUpperCase();
  const grade=document.getElementById('newSGrade').value;
  const field=document.getElementById('newSField').value;
  const subUntilInput=document.getElementById('newSSubUntil').value;
  if(!name||!code){showToast('Ø§Ø³Ù… Ùˆ Ú©Ø¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯','warn');return;}
  if(cachedStudents.find(s=>s.code===code)){showToast('Ø§ÛŒÙ† Ú©Ø¯ Ù‚Ø¨Ù„Ø§Ù‹ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø´Ø¯Ù‡','warn');return;}
  showLoading('Ø¯Ø± Ø­Ø§Ù„ Ø«Ø¨Øª...');
  const{error}=await db.from('students').insert({name,code,grade,field,sub_until:subUntilInput||null});
  if(error){hideLoading();showToast('Ø®Ø·Ø§: '+error.message,'warn');return;}
  document.getElementById('newSName').value='';document.getElementById('newSCode').value='';document.getElementById('newSSubUntil').value='';
  await refreshAll();hideLoading();showToast(`${name} Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯ âœ…`);
}

async function renewSubscription(code,days,exactDate){
  const student=cachedStudents.find(s=>s.code===code);
  if(!student)return;
  let newDate;
  if(exactDate){
    newDate=exactDate;
  } else {
    if(!days||days<1){showToast('ØªØ¹Ø¯Ø§Ø¯ Ø±ÙˆØ² Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯','warn');return;}
    let base=new Date();
    if(student.sub_until&&!isSubExpired(student))base=new Date(student.sub_until);
    base.setDate(base.getDate()+parseInt(days));
    newDate=base.toISOString().split('T')[0];
  }
  showLoading('Ø¯Ø± Ø­Ø§Ù„ ØªÙ…Ø¯ÛŒØ¯...');
  await db.from('students').update({sub_until:newDate}).eq('code',code);
  await refreshAll();hideLoading();
  const jD=toJalali(...newDate.split('-'));
  showToast(`Ø§Ø´ØªØ±Ø§Ú© ${student.name} ØªØ§ ${jalaliStr(jD.y,jD.m,jD.d)} ØªÙ…Ø¯ÛŒØ¯ Ø´Ø¯ âœ…`);
  closeModal('studentModal');openStudentModal(code);
}

function aRenderStudents(){
  const el=document.getElementById('aStudentsList');
  if(!cachedStudents.length){el.innerHTML='<div class="empty" style="grid-column:1/-1"><div class="empty-icon">ğŸ‘¤</div>Ù‡Ù†ÙˆØ² Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ²ÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡</div>';return;}
  el.innerHTML=cachedStudents.map(s=>{
    const sr=cachedReports.filter(r=>r.student_code===s.code);
    const se=cachedExams.filter(e=>e.student_code===s.code);
    const dLeft=subDaysLeft(s);
    const expired=isSubExpired(s);
    const subHtml=expired?`<span class="sub-expired">ğŸ”´ Ù…Ù†Ù‚Ø¶ÛŒ (${toPNum(Math.abs(dLeft))} Ø±ÙˆØ² Ù¾ÛŒØ´)</span>`:dLeft<=7?`<span class="sub-warning">âš ï¸ ${toPNum(dLeft)} Ø±ÙˆØ² Ù…Ø§Ù†Ø¯Ù‡</span>`:`<span class="sub-active">âœ… ${toPNum(dLeft)} Ø±ÙˆØ² Ù…Ø§Ù†Ø¯Ù‡</span>`;
    return`<div class="student-card" onclick="openStudentModal('${s.code}')">
      <div style="font-size:15px;font-weight:700;margin-bottom:3px">${s.name}</div>
      <div style="font-size:11px;color:var(--text-muted);margin-bottom:4px">${s.grade||''} | ${s.field||''}</div>
      <div style="margin-bottom:10px;display:flex;align-items:center;gap:6px;font-size:11px;color:var(--text-muted)">ğŸ”‘ <span class="code-tag" onclick="event.stopPropagation();copyCode('${s.code}')">${s.code}</span></div>
      <div style="margin-bottom:8px">${subHtml}</div>
      <div style="display:flex;gap:10px">
        <div style="font-size:11px;color:var(--text-dim)"><strong>${toPNum(sr.length)}</strong> Ú¯Ø²Ø§Ø±Ø´</div>
        <div style="font-size:11px;color:var(--text-dim)"><strong>${toPNum(se.length)}</strong> Ø¢Ø²Ù…ÙˆÙ†</div>
      </div>
    </div>`;}).join('');
}

function aUpdateSelects(){
  const opts=cachedStudents.map(s=>`<option value="${s.code}">${s.name}</option>`).join('');
  ['aFilterStudent','aFilterExamSt','aChartSt'].forEach(id=>{
    const el=document.getElementById(id);if(!el)return;
    const prev=el.value;el.innerHTML='<option value="">Ù‡Ù…Ù‡</option>'+opts;if(prev)el.value=prev;
  });
}

function aRenderReports(){
  const fc=document.getElementById('aFilterStudent')?.value||'';
  const fd=document.getElementById('aFilterDate')?.value||'';
  let reports=[...cachedReports];
  if(fc)reports=reports.filter(r=>r.student_code===fc);
  if(fd)reports=reports.filter(r=>r.date>=fd);
  const el=document.getElementById('aReportsList');
  if(!reports.length){el.innerHTML='<div class="empty"><div class="empty-icon">ğŸ“­</div>Ú¯Ø²Ø§Ø±Ø´ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯</div>';return;}
  el.innerHTML=reports.map(r=>`<div class="report-row" onclick="openReportModal('${r.id}')">
    <div style="min-width:90px"><div style="font-size:13px;font-weight:700">${r.student_name}</div><div style="font-size:11px;color:var(--text-muted)">${gregorianToJalaliStr(r.date)}</div></div>
    <div style="font-size:11px;color:var(--text-dim)">â±ï¸ ${toPNum(Math.floor(r.total_mins/60))}:${String(r.total_mins%60).padStart(2,'0')} Ø³Ø§Ø¹Øª</div>
    <div style="font-size:11px;color:var(--text-dim)">ğŸ¯ ${toPNum(r.total_tests)} ØªØ³Øª</div>
    <div style="font-size:11px;color:var(--text-dim)">ğŸ“š ${toPNum((typeof r.lessons==='string'?JSON.parse(r.lessons||'[]'):r.lessons||[]).length)} Ø¯Ø±Ø³</div>
    ${satBadge(r.satisfaction)}
    ${r.mood==='great'?'<span>ğŸ”¥</span>':r.mood==='bad'?'<span>ğŸ˜</span>':''}
  </div>`).join('');
}

function aRenderExams(){
  const fc=document.getElementById('aFilterExamSt')?.value||'';
  let exams=[...cachedExams];
  if(fc)exams=exams.filter(e=>e.student_code===fc);
  const el=document.getElementById('aExamsList');
  if(!exams.length){el.innerHTML='<div class="empty"><div class="empty-icon">ğŸ†</div>Ø¢Ø²Ù…ÙˆÙ†ÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡</div>';return;}
  el.innerHTML=`<div class="table-wrap"><table><thead><tr><th>Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ²</th><th>Ù†Ø§Ù… Ø¢Ø²Ù…ÙˆÙ†</th><th>Ù†ÙˆØ¹</th><th>ØªØ§Ø±ÛŒØ®</th><th>ØªØ±Ø§Ø²</th><th>Ø±ØªØ¨Ù‡</th><th></th></tr></thead><tbody>
    ${exams.map(e=>`<tr><td><strong>${e.student_name}</strong></td><td>${e.exam_name}</td><td><span class="badge bg-purple">${e.type}</span></td><td>${gregorianToJalaliStr(e.date)}</td><td>${e.taraz?`<strong class="c-gold">${toPNum(e.taraz)}</strong>`:'â€”'}</td><td>${e.rank?`<strong class="c-purple">${toPNum(e.rank)}</strong>`:'â€”'}</td><td><button class="btn btn-outline btn-sm" onclick="openExamModal('${e.id}')">Ù…Ø´Ø§Ù‡Ø¯Ù‡</button></td></tr>`).join('')}
  </tbody></table></div>`;
}

function aRenderCharts(){
  const code=document.getElementById('aChartSt').value;
  const area=document.getElementById('aChartsArea');
  if(!code){area.innerHTML='<div class="empty" style="padding:50px"><div class="empty-icon">ğŸ“Š</div>ÛŒÙ‡ Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ² Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†</div>';return;}
  renderChartsForCode(code,area,'a');
}

// ===== STUDENT APP =====
async function initStudentApp(){
  showLoading('Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ...');
  const[r,e]=await Promise.all([
    db.from('reports').select('*').eq('student_code',currentStudent.code).order('created_at',{ascending:false}),
    db.from('exams').select('*').eq('student_code',currentStudent.code).order('created_at',{ascending:false})
  ]);
  cachedReports=r.data||[];cachedExams=e.data||[];
  hideLoading();

  document.getElementById('sHeaderName').textContent=currentStudent.name;
  document.getElementById('sHeaderGrade').textContent=(currentStudent.grade||'')+(currentStudent.field?' | '+currentStudent.field:'');
  document.getElementById('sLogoIcon').textContent=currentStudent.name.charAt(0);
  document.getElementById('sDate').valueAsDate=new Date();
  document.getElementById('sQuote').innerHTML='ğŸ’¡ '+QUOTES[Math.floor(Math.random()*QUOTES.length)];
  // ØªØ§Ø±ÛŒØ® Ø§Ù…Ø±ÙˆØ² Ø¨Ù‡ Ø´Ù…Ø³ÛŒ
  const todayISO=new Date().toISOString().split('T')[0];
  document.getElementById('sDate').value=todayISO;
  document.getElementById('sDateDisplay').textContent='ğŸ“… '+gregorianToJalaliStr(todayISO);
  const examDateEl=document.getElementById('sExamDate');
  if(examDateEl){examDateEl.value=todayISO;document.getElementById('sExamDateDisplay').textContent='ğŸ“… '+gregorianToJalaliStr(todayISO);}
  buildSExamSubjGrid();
  sRenderHome();
  sAddLesson();sAddLesson();
  sUpdateSat(70);
}

function sShowPage(name,btn){
  document.querySelectorAll('#studentApp .page-section').forEach(s=>s.classList.remove('active'));
  document.querySelectorAll('#studentApp .nav-btn').forEach(b=>b.classList.remove('active'));
  document.getElementById('s-'+name).classList.add('active');
  if(btn)btn.classList.add('active');
  if(name==='home')sRenderHome();
  if(name==='history')sRenderHistory();
  if(name==='exams')sRenderSExams();
  if(name==='progress')sRenderProgress();
}

function sRenderHome(){
  // Name & info
  document.getElementById('shName').textContent=currentStudent.name;
  document.getElementById('shGrade').innerHTML='ğŸ“š '+( currentStudent.grade||'â€”');
  document.getElementById('shField').innerHTML='ğŸ¯ '+(currentStudent.field||'â€”');

  // Countdowns
  const dT=daysUntil(TAJROBI_DATE);
  const dR=daysUntil(RIAZI_DATE);
  document.getElementById('cdTajrobi').textContent=toPNum(Math.max(0,dT));
  document.getElementById('cdRiazi').textContent=toPNum(Math.max(0,dR));
  const jT=toJalali(TAJROBI_DATE.getFullYear(),TAJROBI_DATE.getMonth()+1,TAJROBI_DATE.getDate());
  const jR=toJalali(RIAZI_DATE.getFullYear(),RIAZI_DATE.getMonth()+1,RIAZI_DATE.getDate());
  document.getElementById('cdTajrobiDate').textContent=jalaliStr(jT.y,jT.m,jT.d);
  document.getElementById('cdRiaziDate').textContent=jalaliStr(jR.y,jR.m,jR.d);

  // Subscription status
  const dLeft=subDaysLeft(currentStudent);
  const expired=isSubExpired(currentStudent);
  let subHtml='';
  if(expired){
    const abs=Math.abs(dLeft);
    subHtml=`<div class="sub-status-box sub-bad"><div class="ssb-icon">ğŸ”´</div><div><div class="ssb-title">Ø§Ø´ØªØ±Ø§Ú© Ù…Ø´Ø§ÙˆØ±Ù‡ Ù…Ù†Ù‚Ø¶ÛŒ Ø´Ø¯Ù‡!</div><div class="ssb-sub">${toPNum(abs)} Ø±ÙˆØ² Ø§Ø² ØªØ§Ø±ÛŒØ® Ù¾Ø±Ø¯Ø§Ø®Øª Ú¯Ø°Ø´ØªÙ‡ â€” Ø¨Ø§ Ù…Ù‡Ø¯ÛŒ Ø¨Ø§Ù‚Ø±ÛŒØ§Ù† ØªÙ…Ø§Ø³ Ø¨Ú¯ÛŒØ±</div></div></div>`;
  } else if(dLeft<=7){
    const jU=toJalali(...currentStudent.sub_until.split('-'));
    subHtml=`<div class="sub-status-box sub-warn"><div class="ssb-icon">âš ï¸</div><div><div class="ssb-title">Ø§Ø´ØªØ±Ø§Ú© Ø¯Ø± Ø­Ø§Ù„ Ø§ØªÙ…Ø§Ù…</div><div class="ssb-sub">${toPNum(dLeft)} Ø±ÙˆØ² Ù…Ø§Ù†Ø¯Ù‡ â€” ØªØ§ ${jalaliStr(jU.y,jU.m,jU.d)} Ø§Ø¹ØªØ¨Ø§Ø± Ø¯Ø§Ø±ÛŒ</div></div></div>`;
  } else {
    const jU=toJalali(...currentStudent.sub_until.split('-'));
    subHtml=`<div class="sub-status-box sub-ok"><div class="ssb-icon">âœ…</div><div><div class="ssb-title">Ø§Ø´ØªØ±Ø§Ú© ÙØ¹Ø§Ù„</div><div class="ssb-sub">${toPNum(dLeft)} Ø±ÙˆØ² Ù…Ø§Ù†Ø¯Ù‡ â€” ØªØ§ ${jalaliStr(jU.y,jU.m,jU.d)}</div></div></div>`;
  }
  document.getElementById('subStatusBox').innerHTML=subHtml;

  // Streak
  let streak=0;const today=new Date();
  for(let i=0;i<30;i++){const d=new Date(today);d.setDate(d.getDate()-i);const ds=d.toISOString().split('T')[0];if(cachedReports.find(r=>r.date===ds))streak++;else if(i>0)break;}
  document.getElementById('sStreakBox').innerHTML=`<div style="font-size:30px">ğŸ”¥</div><div style="flex:1"><div style="font-size:22px;font-weight:900;color:var(--gold)">${toPNum(streak)} Ø±ÙˆØ²</div><div style="font-size:11px;color:var(--text-muted)">Ø§Ø³ØªØ±ÛŒÚ© Ù…Ø·Ø§Ù„Ø¹Ù‡ Ù…ØªÙˆØ§Ù„ÛŒ</div></div><div style="font-size:12px;color:var(--text-muted);text-align:left">${streak>=7?'ğŸ… Ù‡ÙØªÙ‡â€ŒØ§ÛŒ!':streak>=3?'âš¡ Ø¹Ø§Ù„ÛŒÙ‡!':'Ø§Ø¯Ø§Ù…Ù‡ Ø¨Ø¯Ù‡!'}</div>`;

  // Week stats
  const weekAgo=new Date();weekAgo.setDate(weekAgo.getDate()-7);
  const weekStr=weekAgo.toISOString().split('T')[0];
  const wr=cachedReports.filter(r=>r.date>=weekStr);
  const wMins=wr.reduce((s,r)=>s+r.total_mins,0);
  const wTests=wr.reduce((s,r)=>s+r.total_tests,0);
  document.getElementById('sWeekStats').innerHTML=`
    <div class="stat-card"><div class="stat-num c-purple" style="font-size:20px">${toPNum(wr.length)}</div><div class="stat-lbl">Ú¯Ø²Ø§Ø±Ø´ Ø§ÛŒÙ† Ù‡ÙØªÙ‡</div></div>
    <div class="stat-card"><div class="stat-num c-cyan" style="font-size:20px">${toPNum(Math.floor(wMins/60))}:${String(wMins%60).padStart(2,'0')}</div><div class="stat-lbl">Ø³Ø§Ø¹Øª Ù…Ø·Ø§Ù„Ø¹Ù‡</div></div>
    <div class="stat-card"><div class="stat-num c-gold" style="font-size:20px">${toPNum(wTests)}</div><div class="stat-lbl">ØªØ³Øª Ø²Ø¯Ù‡</div></div>`;
}

function sAddLesson(){
  sLessonCount++;const id='sl'+sLessonCount;
  const subjects=getSubjects(currentStudent?.field);
  const div=document.createElement('div');div.className='lesson-row';div.id=id;
  div.innerHTML=`<button class="rm-btn" onclick="sRemoveLesson('${id}')">âœ•</button>
    <div class="lesson-top">
      <div class="form-group"><label>Ù†Ø§Ù… Ø¯Ø±Ø³</label>
        <select class="ls-name">
          ${subjects.map(s=>`<option>${s}</option>`).join('')}
          <option value="__custom__">âœï¸ Ø¯Ø±Ø³ Ø¯ÛŒÚ¯Ù‡...</option>
        </select>
      </div>
      <div class="form-group"><label>Ù†ÙˆØ¹</label><select class="ls-type" onchange="sToggleType(this,'${id}')"><option value="study">ğŸ“– Ù…Ø·Ø§Ù„Ø¹Ù‡</option><option value="test">ğŸ¯ ØªØ³Øª</option><option value="both">ğŸ“–+ğŸ¯ Ù‡Ø± Ø¯Ùˆ</option></select></div>
      <div class="form-group"><label>Ø¯Ù‚ÛŒÙ‚Ù‡</label><input type="number" class="ls-mins" min="0" placeholder="Û°" oninput="sUpdateSummary()"></div>
    </div>
    <div class="lesson-custom" id="lcustom-${id}" style="display:none;margin-bottom:9px">
      <div class="form-group"><label>Ø§Ø³Ù… Ø¯Ø±Ø³ Ø¯Ù„Ø®ÙˆØ§Ù‡</label><input type="text" class="ls-custom-name" placeholder="Ø§Ø³Ù… Ø¯Ø±Ø³ Ø±Ùˆ Ø¨Ù†ÙˆÛŒØ³"></div>
    </div>
    <div class="lesson-bot" id="lbot-${id}" style="display:none">
      <div class="form-group"><label>ØªØ¹Ø¯Ø§Ø¯ ØªØ³Øª</label><input type="number" class="ls-total" min="0" placeholder="Û°" oninput="sUpdateSummary()"></div>
      <div class="form-group"><label>âœ… Ø¯Ø±Ø³Øª</label><input type="number" class="ls-correct" min="0" placeholder="Û°" oninput="sUpdateSummary()"></div>
      <div class="form-group"><label>âŒ ØºÙ„Ø·</label><input type="number" class="ls-wrong" min="0" placeholder="Û°" oninput="sUpdateSummary()"></div>
      <div class="form-group"><label>â¬œ Ù†Ø²Ø¯Ù‡</label><input type="number" class="ls-skip" min="0" placeholder="Û°" oninput="sUpdateSummary()"></div>
    </div>
    <div class="form-group lesson-note"><label>ğŸ’¬ ØªÙˆØ¶ÛŒØ­Ø§Øª Ø§ÛŒÙ† Ø¯Ø±Ø³</label><input type="text" class="ls-note" placeholder="Ù…Ø«Ù„Ø§Ù‹: ÙØµÙ„ Û³ Ø±Ùˆ ØªÙ…ÙˆÙ… Ú©Ø±Ø¯Ù…ØŒ Ù‡Ù†ÙˆØ² Ø¨Ø§ Ù…Ø¨Ø­Ø« x Ù…Ø´Ú©Ù„ Ø¯Ø§Ø±Ù…"></div>`;
  document.getElementById('sLessonsContainer').appendChild(div);
  // listen for custom subject select
  div.querySelector('.ls-name').addEventListener('change',function(){
    const c=document.getElementById('lcustom-'+id);
    if(c)c.style.display=this.value==='__custom__'?'block':'none';
  });
  sUpdateSummary();
}

function sRemoveLesson(id){document.getElementById(id)?.remove();sUpdateSummary();}
function sToggleType(sel,id){const b=document.getElementById('lbot-'+id);if(b)b.style.display=sel.value==='study'?'none':'grid';sUpdateSummary();}
function sUpdateSummary(){
  let tm=0,tt=0,tc=0;
  document.querySelectorAll('#sLessonsContainer .lesson-row').forEach(row=>{tm+=parseInt(row.querySelector('.ls-mins')?.value||0);tt+=parseInt(row.querySelector('.ls-total')?.value||0);tc+=parseInt(row.querySelector('.ls-correct')?.value||0);});
  const h=Math.floor(tm/60),m=tm%60;
  document.getElementById('sSumH').textContent=`${toPNum(h)}:${toPNum(m).padStart(2,'Û°')}`;
  document.getElementById('sSumT').textContent=toPNum(tt);
  document.getElementById('sSumP').textContent=tt>0?toPNum(Math.round(tc/tt*100))+'Ùª':'â€”';
}
function sUpdateSat(v){document.getElementById('sSatV').textContent=toPNum(v)+'Ùª';document.getElementById('sSatE').textContent=v>=85?'ğŸ¤©':v>=65?'ğŸ˜Š':v>=45?'ğŸ˜':v>=25?'ğŸ˜•':'ğŸ˜';}

async function sSubmitReport(){
  const date=document.getElementById('sDate').value;
  if(!date){showToast('ØªØ§Ø±ÛŒØ® Ø±Ùˆ ÙˆØ§Ø±Ø¯ Ú©Ù†','warn');return;}
  const lessons=[];let tm=0,tt=0;
  document.querySelectorAll('#sLessonsContainer .lesson-row').forEach(row=>{
    const mins=parseInt(row.querySelector('.ls-mins')?.value||0);
    const total=parseInt(row.querySelector('.ls-total')?.value||0);
    const correct=parseInt(row.querySelector('.ls-correct')?.value||0);
    const wrong=parseInt(row.querySelector('.ls-wrong')?.value||0);
    const skip=parseInt(row.querySelector('.ls-skip')?.value||0);
    const note=row.querySelector('.ls-note')?.value||'';
    const nameEl=row.querySelector('.ls-name');
    const rawName=nameEl.value;
    const customName=row.querySelector('.ls-custom-name')?.value?.trim();
    const lessonName=rawName==='__custom__'?(customName||'Ø¯Ø±Ø³ Ø¯ÛŒÚ¯Ø±'):rawName;
    tm+=mins;tt+=total;
    lessons.push({name:lessonName,type:row.querySelector('.ls-type').value,mins,total,correct,wrong,skip,note});
  });
  const btn=document.getElementById('sSubmitBtn');btn.disabled=true;btn.textContent='Ø¯Ø± Ø­Ø§Ù„ Ø«Ø¨Øª...';
  const{error}=await db.from('reports').insert({student_code:currentStudent.code,student_name:currentStudent.name,date,mood:document.getElementById('sMood').value,lessons:JSON.stringify(lessons),total_mins:tm,total_tests:tt,satisfaction:parseInt(document.getElementById('sSatS').value),notes:document.getElementById('sNotes').value});
  btn.disabled=false;btn.textContent='âœ… Ø«Ø¨Øª Ú¯Ø²Ø§Ø±Ø´ Ø§Ù…Ø±ÙˆØ²';
  if(error){showToast('Ø®Ø·Ø§: '+error.message,'warn');return;}
  const{data}=await db.from('reports').select('*').eq('student_code',currentStudent.code).order('created_at',{ascending:false});
  cachedReports=data||[];
  showToast('Ú¯Ø²Ø§Ø±Ø´ Ø§Ù…Ø±ÙˆØ²Øª Ø«Ø¨Øª Ø´Ø¯ âœ…');
  const newToday=new Date().toISOString().split('T')[0];
  document.getElementById('sDate').value=newToday;
  document.getElementById('sDateDisplay').textContent='ğŸ“… '+gregorianToJalaliStr(newToday);
  document.getElementById('sNotes').value='';document.getElementById('sSatS').value=70;sUpdateSat(70);
  document.getElementById('sLessonsContainer').innerHTML='';sLessonCount=0;sAddLesson();sAddLesson();sUpdateSummary();
}

function sRenderHistory(){
  const el=document.getElementById('sHistoryList');
  if(!cachedReports.length){el.innerHTML='<div class="empty"><div class="empty-icon">ğŸ“­</div>Ù‡Ù†ÙˆØ² Ú¯Ø²Ø§Ø±Ø´ÛŒ Ø«Ø¨Øª Ù†Ú©Ø±Ø¯ÛŒ</div>';return;}
  el.innerHTML=cachedReports.map(r=>`<div class="report-row" onclick="openReportModal('${r.id}')">
    <div style="min-width:90px"><div style="font-size:13px;font-weight:700">${gregorianToJalaliStr(r.date)}</div><div style="font-size:11px;color:var(--text-muted)">${r.mood==='great'?'ğŸ”¥ Ø®ÛŒÙ„ÛŒ Ø®ÙˆØ¨':r.mood==='good'?'ğŸ˜Š Ø®ÙˆØ¨':r.mood==='ok'?'ğŸ˜ Ù…Ø¹Ù…ÙˆÙ„ÛŒ':'ğŸ˜ Ø¨Ø¯'}</div></div>
    <div style="font-size:11px;color:var(--text-dim)">â±ï¸ ${toPNum(Math.floor(r.total_mins/60))}:${String(r.total_mins%60).padStart(2,'0')} Ø³Ø§Ø¹Øª</div>
    <div style="font-size:11px;color:var(--text-dim)">ğŸ¯ ${toPNum(r.total_tests)} ØªØ³Øª</div>
    ${satBadge(r.satisfaction)}
  </div>`).join('');
}

// STUDENT EXAMS
function buildSExamSubjGrid(){
  const g=document.getElementById('sExamSubjGrid');if(!g)return;
  const subjects=getSubjects(currentStudent?.field);
  g.innerHTML=subjects.map(s=>`<div class="form-group"><label>${s}</label><input type="number" class="s-exam-sp" data-s="${s}" min="0" max="100" placeholder="Ø¯Ø±ØµØ¯"></div>`).join('');
}

async function sAddExam(){
  const name=document.getElementById('sExamName').value.trim();
  const type=document.getElementById('sExamType').value;
  const date=document.getElementById('sExamDate').value;
  const taraz=document.getElementById('sExamTaraz').value;
  const rank=document.getElementById('sExamRank').value;
  if(!name||!date){showToast('Ù†Ø§Ù… Ø¢Ø²Ù…ÙˆÙ† Ùˆ ØªØ§Ø±ÛŒØ® Ø§Ù„Ø²Ø§Ù…ÛŒÙ‡','warn');return;}
  const subjects={};document.querySelectorAll('.s-exam-sp').forEach(inp=>{if(inp.value)subjects[inp.dataset.s]=parseFloat(inp.value);});
  const btn=document.getElementById('sExamSubmitBtn');btn.disabled=true;btn.textContent='Ø¯Ø± Ø­Ø§Ù„ Ø«Ø¨Øª...';
  const{error}=await db.from('exams').insert({student_code:currentStudent.code,student_name:currentStudent.name,exam_name:name,type,date,taraz:taraz?parseInt(taraz):null,rank:rank?parseInt(rank):null,subjects:JSON.stringify(subjects)});
  btn.disabled=false;btn.textContent='âœ… Ø«Ø¨Øª Ù†ØªÛŒØ¬Ù‡';
  if(error){showToast('Ø®Ø·Ø§: '+error.message,'warn');return;}
  document.getElementById('sExamName').value='';document.getElementById('sExamTaraz').value='';document.getElementById('sExamRank').value='';
  document.getElementById('sExamDate').valueAsDate=new Date();
  document.querySelectorAll('.s-exam-sp').forEach(i=>i.value='');
  const{data}=await db.from('exams').select('*').eq('student_code',currentStudent.code).order('created_at',{ascending:false});
  cachedExams=data||[];sRenderSExams();showToast('Ù†ØªÛŒØ¬Ù‡ Ø¢Ø²Ù…ÙˆÙ† Ø«Ø¨Øª Ø´Ø¯ âœ…');
}

function sRenderSExams(){
  const el=document.getElementById('sExamsList');
  if(!cachedExams.length){el.innerHTML='<div class="empty"><div class="empty-icon">ğŸ†</div>Ù‡Ù†ÙˆØ² Ø¢Ø²Ù…ÙˆÙ†ÛŒ Ø«Ø¨Øª Ù†Ú©Ø±Ø¯ÛŒ</div>';return;}
  el.innerHTML=cachedExams.map(e=>`<div class="report-row" onclick="openExamModal('${e.id}')">
    <div style="flex:1"><div style="font-size:13px;font-weight:700">${e.exam_name}</div><div style="font-size:11px;color:var(--text-muted)">${gregorianToJalaliStr(e.date)}</div></div>
    <span class="badge bg-purple">${e.type}</span>
    ${e.taraz?`<span class="badge bg-gold" style="background:rgba(245,158,11,0.15);color:var(--gold)">ØªØ±Ø§Ø² ${toPNum(e.taraz)}</span>`:''}
    ${e.rank?`<span class="badge bg-cyan">Ø±ØªØ¨Ù‡ ${toPNum(e.rank)}</span>`:''}
  </div>`).join('');
}

function sRenderProgress(){renderChartsForCode(currentStudent.code,document.getElementById('sProgressArea'),'s');}

// ===== CHARTS =====
function renderChartsForCode(code,area,prefix){
  const reports=[...cachedReports].filter(r=>r.student_code===code).sort((a,b)=>a.date.localeCompare(b.date));
  const exams=[...cachedExams].filter(e=>e.student_code===code).sort((a,b)=>a.date.localeCompare(b.date));
  let html='';
  html+=`<div class="card"><div class="card-title" style="margin-bottom:12px"><div class="ibox ib-purple">â±ï¸</div>Ø³Ø§Ø¹Øª Ù…Ø·Ø§Ù„Ø¹Ù‡ Ø±ÙˆØ²Ø§Ù†Ù‡</div><div class="chart-box"><canvas id="${prefix}c1" height="160"></canvas></div></div>`;
  html+=`<div class="card"><div class="card-title" style="margin-bottom:12px"><div class="ibox ib-gold">ğŸ˜Š</div>Ø±Ø¶Ø§ÛŒØª Ø±ÙˆØ²Ø§Ù†Ù‡</div><div class="chart-box"><canvas id="${prefix}c2" height="160"></canvas></div></div>`;
  html+=`<div class="card"><div class="card-title" style="margin-bottom:12px"><div class="ibox ib-cyan">ğŸ¯</div>ØªØ¹Ø¯Ø§Ø¯ ØªØ³Øª Ø±ÙˆØ²Ø§Ù†Ù‡</div><div class="chart-box"><canvas id="${prefix}c3" height="160"></canvas></div></div>`;
  if(exams.filter(e=>e.taraz).length>0)html+=`<div class="card"><div class="card-title" style="margin-bottom:12px"><div class="ibox ib-green">ğŸ“</div>Ø±ÙˆÙ†Ø¯ ØªØ±Ø§Ø²</div><div class="chart-box"><canvas id="${prefix}c4" height="160"></canvas></div></div>`;
  const allSubj=new Set();exams.forEach(e=>{const s=typeof e.subjects==='string'?JSON.parse(e.subjects||'{}'):e.subjects||{};Object.keys(s).forEach(k=>allSubj.add(k));});
  if(allSubj.size){
    html+=`<div class="card"><div class="card-title" style="margin-bottom:14px"><div class="ibox ib-cyan">ğŸ“š</div>Ø±ÙˆÙ†Ø¯ Ø¯Ø±ØµØ¯ Ù‡Ø± Ø¯Ø±Ø³ Ø¯Ø± Ø¢Ø²Ù…ÙˆÙ†â€ŒÙ‡Ø§</div>`;
    allSubj.forEach(subj=>{html+=`<div style="margin-bottom:11px"><div style="font-size:12px;font-weight:700;color:var(--text-dim);margin-bottom:7px">${subj}</div><div class="chart-box"><canvas id="${prefix}cs_${subj.replace(/[\sâ€Œ]/g,'_')}" height="110"></canvas></div></div>`;});
    html+=`</div>`;
  }
  area.innerHTML=html;
  const cmap={'Ø²ÛŒØ³Øªâ€ŒØ´Ù†Ø§Ø³ÛŒ':'#10b981','Ø´ÛŒÙ…ÛŒ':'#3b82f6','ÙÛŒØ²ÛŒÚ©':'#f59e0b','Ø±ÛŒØ§Ø¶ÛŒ':'#ef4444','Ø§Ø¯Ø¨ÛŒØ§Øª':'#8b5cf6','Ø¹Ø±Ø¨ÛŒ':'#f97316','Ø¯ÛŒÙ† Ùˆ Ø²Ù†Ø¯Ú¯ÛŒ':'#06b6d4','Ø²Ø¨Ø§Ù† Ø§Ù†Ú¯Ù„ÛŒØ³ÛŒ':'#ec4899'};
  setTimeout(()=>{
    const rl=reports.map(r=>gregorianToJalaliStr(r.date).replace(/\s/g,'\n'));
    drawLine(prefix+'c1',rl,reports.map(r=>+(r.total_mins/60).toFixed(1)),'#a855f7');
    drawLine(prefix+'c2',rl,reports.map(r=>r.satisfaction),'#f59e0b');
    drawLine(prefix+'c3',rl,reports.map(r=>r.total_tests),'#06b6d4');
    if(document.getElementById(prefix+'c4')){const te=exams.filter(e=>e.taraz);drawLine(prefix+'c4',te.map(e=>e.exam_name.slice(0,8)),te.map(e=>e.taraz),'#10b981');}
    allSubj.forEach(subj=>{
      const cid=prefix+'cs_'+subj.replace(/[\sâ€Œ]/g,'_');
      const se=exams.filter(e=>{const s=typeof e.subjects==='string'?JSON.parse(e.subjects||'{}'):e.subjects||{};return subj in s;});
      drawLine(cid,se.map(e=>e.exam_name.slice(0,7)),se.map(e=>{const s=typeof e.subjects==='string'?JSON.parse(e.subjects||'{}'):e.subjects||{};return s[subj];}),cmap[subj]||'#94a3b8');
    });
  },60);
}

// ===== MODALS =====
function openReportModal(id){
  const r=cachedReports.find(x=>String(x.id)===String(id));if(!r)return;
  document.getElementById('rMTitle').textContent=`${r.student_name} â€” ${gregorianToJalaliStr(r.date)}`;
  const h=Math.floor(r.total_mins/60),m=r.total_mins%60;
  const lessons=typeof r.lessons==='string'?JSON.parse(r.lessons||'[]'):r.lessons||[];
  const moodLabel=r.mood==='great'?'ğŸ”¥ Ø®ÛŒÙ„ÛŒ Ø®ÙˆØ¨':r.mood==='good'?'ğŸ˜Š Ø®ÙˆØ¨':r.mood==='ok'?'ğŸ˜ Ù…Ø¹Ù…ÙˆÙ„ÛŒ':'ğŸ˜ Ø¨Ø¯';
  document.getElementById('rMContent').innerHTML=`
    <div class="report-detail-grid">
      <div class="sum-card"><div class="sum-val c-purple" style="font-size:20px">${toPNum(h)}:${String(m).padStart(2,'0')}</div><div class="sum-lbl">Ø³Ø§Ø¹Øª Ù…Ø·Ø§Ù„Ø¹Ù‡</div></div>
      <div class="sum-card"><div class="sum-val c-cyan" style="font-size:20px">${toPNum(r.total_tests)}</div><div class="sum-lbl">Ù…Ø¬Ù…ÙˆØ¹ ØªØ³Øª</div></div>
      <div class="sum-card"><div class="sum-val" style="font-size:20px;color:${r.satisfaction>=70?'var(--success)':r.satisfaction>=40?'var(--gold)':'var(--danger)'}">${toPNum(r.satisfaction)}Ùª</div><div class="sum-lbl">Ø±Ø¶Ø§ÛŒØª</div></div>
    </div>
    <div style="display:flex;align-items:center;gap:8px;margin-bottom:14px;padding:8px 12px;background:var(--surface2);border-radius:8px">
      <span style="font-size:12px;color:var(--text-muted)">ÙˆØ¶Ø¹ÛŒØª Ø±ÙˆØ²:</span>
      <strong style="font-size:13px">${moodLabel}</strong>
    </div>
    <div style="font-size:12px;font-weight:700;color:var(--text-dim);margin-bottom:10px">ğŸ“š Ø¬Ø²Ø¦ÛŒØ§Øª Ø¯Ø±Ø³â€ŒÙ‡Ø§:</div>
    <div style="display:flex;flex-direction:column;gap:8px;margin-bottom:14px">
      ${lessons.map(l=>`
        <div class="report-lesson-card">
          <div class="rlc-name">
            ğŸ“– ${l.name}
            <span class="badge bg-purple" style="font-size:10px">${l.type==='study'?'Ù…Ø·Ø§Ù„Ø¹Ù‡':l.type==='test'?'ØªØ³Øª':'Ù…Ø·Ø§Ù„Ø¹Ù‡+ØªØ³Øª'}</span>
          </div>
          <div class="rlc-stats">
            <span class="badge bg-cyan">â±ï¸ ${toPNum(l.mins)} Ø¯Ù‚ÛŒÙ‚Ù‡</span>
            ${l.total>0?`<span class="badge bg-blue">ğŸ“ ${toPNum(l.total)} ØªØ³Øª</span>`:''}
            ${l.correct>0?`<span class="badge bg-green">âœ… ${toPNum(l.correct)} Ø¯Ø±Ø³Øª</span>`:''}
            ${l.wrong>0?`<span class="badge bg-red">âŒ ${toPNum(l.wrong)} ØºÙ„Ø·</span>`:''}
            ${l.skip>0?`<span class="badge" style="background:rgba(100,116,139,0.2);color:var(--text-muted)">â¬œ ${toPNum(l.skip)} Ù†Ø²Ø¯Ù‡</span>`:''}
            ${l.total>0?`<span class="badge bg-amber">ğŸ“Š ${toPNum(Math.round((l.correct||0)/l.total*100))}Ùª</span>`:''}
          </div>
          ${l.note?`<div class="rlc-note">ğŸ’¬ ${l.note}</div>`:''}
        </div>`).join('')}
    </div>
    ${r.notes?`<div style="background:var(--surface2);padding:12px;border-radius:9px;font-size:12px;color:var(--text-dim);line-height:1.7;border:1px solid var(--border2)"><strong style="color:var(--text-dim)">ğŸ“ ÛŒØ§Ø¯Ø¯Ø§Ø´Øª Ú©Ù„ÛŒ:</strong><br>${r.notes}</div>`:''}`;
  document.getElementById('reportModal').classList.add('open');
}

function openExamModal(id){
  const e=cachedExams.find(x=>String(x.id)===String(id));if(!e)return;
  document.getElementById('eMTitle').textContent=`${e.student_name} â€” ${e.exam_name}`;
  const subjs=Object.entries(typeof e.subjects==='string'?JSON.parse(e.subjects||'{}'):e.subjects||{});
  document.getElementById('eMContent').innerHTML=`
    <div style="display:flex;flex-wrap:wrap;gap:7px;margin-bottom:16px">
      <span class="badge bg-purple">${e.type}</span>
      <span class="badge bg-cyan">ğŸ“… ${gregorianToJalaliStr(e.date)}</span>
      ${e.taraz?`<span class="badge bg-amber">ğŸ“ ØªØ±Ø§Ø² ${toPNum(e.taraz)}</span>`:''}
      ${e.rank?`<span class="badge bg-blue">ğŸ… Ø±ØªØ¨Ù‡ ${toPNum(e.rank)}</span>`:''}
    </div>
    ${subjs.length?`<div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(130px,1fr));gap:9px">${subjs.map(([s,p])=>`<div style="background:var(--surface2);padding:12px;border-radius:9px;text-align:center;border:1px solid var(--border2)"><div style="font-size:11px;color:var(--text-muted);margin-bottom:6px">${s}</div><div style="font-size:22px;font-weight:800;color:${p>=60?'var(--success)':p>=40?'var(--gold)':'var(--danger)'}">${toPNum(p)}Ùª</div></div>`).join('')}</div>`:'<div style="color:var(--text-muted);text-align:center;padding:20px">Ø¯Ø±ØµØ¯ Ø¯Ø±Ø³ÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡</div>'}`;
  document.getElementById('examModal').classList.add('open');
}

function openStudentModal(code){
  const s=cachedStudents.find(x=>x.code===code);if(!s)return;
  const sr=cachedReports.filter(r=>r.student_code===code);
  const se=cachedExams.filter(e=>e.student_code===code);
  const dLeft=subDaysLeft(s);
  const expired=isSubExpired(s);
  const subText=expired?`ğŸ”´ Ù…Ù†Ù‚Ø¶ÛŒ â€” ${toPNum(Math.abs(dLeft))} Ø±ÙˆØ² Ù¾ÛŒØ´ Ú¯Ø°Ø´ØªÙ‡`:`âœ… ${toPNum(dLeft)} Ø±ÙˆØ² Ù…Ø§Ù†Ø¯Ù‡`;
  const jSub=s.sub_until?toJalali(...s.sub_until.split('-')):null;
  document.getElementById('stMTitle').textContent=s.name;
  document.getElementById('stMContent').innerHTML=`
    <div style="display:flex;flex-wrap:wrap;gap:8px;margin-bottom:16px">
      <span class="badge bg-purple">${s.grade||'â€”'}</span>
      <span class="badge bg-cyan">${s.field||'â€”'}</span>
      <span class="code-tag" onclick="copyCode('${s.code}')">${s.code}</span>
      <button class="btn btn-danger btn-sm" onclick="deleteStudent('${s.code}')">ğŸ—‘ï¸ Ø­Ø°Ù</button>
    </div>
    <div style="background:${expired?'rgba(239,68,68,0.08)':'rgba(16,185,129,0.08)'};border:1px solid ${expired?'rgba(239,68,68,0.3)':'rgba(16,185,129,0.25)'};border-radius:10px;padding:12px;margin-bottom:14px">
      <div style="font-size:12px;font-weight:700;margin-bottom:4px">${subText}</div>
      ${jSub?`<div style="font-size:11px;color:var(--text-muted)">ØªØ§Ø±ÛŒØ® Ø§Ù†Ù‚Ø¶Ø§: ${jalaliStr(jSub.y,jSub.m,jSub.d)}</div>`:''}
    </div>
    <div style="font-size:12px;font-weight:700;color:var(--text-dim);margin-bottom:8px">ğŸ”„ ØªÙ…Ø¯ÛŒØ¯ Ø§Ø´ØªØ±Ø§Ú©:</div>
    <div class="renew-box" style="flex-direction:column;align-items:stretch;gap:10px">
      <div style="display:flex;gap:8px;align-items:center">
        <div class="form-group" style="flex:1;margin:0"><label>ØªØ¹Ø¯Ø§Ø¯ Ø±ÙˆØ² Ø§Ø¶Ø§ÙÙ‡</label><input type="number" id="renewDays" placeholder="Ù…Ø«Ù„Ø§Ù‹: 30" min="1" value="30" style="text-align:center"></div>
        <button class="btn btn-gold" style="margin-top:16px" onclick="renewSubscription('${s.code}',document.getElementById('renewDays').value,null)">â• ØªÙ…Ø¯ÛŒØ¯</button>
      </div>
      <div style="font-size:11px;color:var(--text-muted);text-align:center">â€” ÛŒØ§ â€”</div>
      <div style="display:flex;gap:8px;align-items:center">
        <div class="form-group" style="flex:1;margin:0"><label>ØªØ§Ø±ÛŒØ® Ø¯Ù‚ÛŒÙ‚ Ø§Ù†Ù‚Ø¶Ø§ (Ù…ÛŒÙ„Ø§Ø¯ÛŒ)</label><input type="date" id="renewDate"></div>
        <button class="btn btn-success" style="margin-top:16px" onclick="renewSubscription('${s.code}',null,document.getElementById('renewDate').value)">ğŸ“… Ø«Ø¨Øª</button>
      </div>
      <div style="display:flex;gap:6px">
        <button class="btn btn-outline btn-sm" onclick="document.getElementById('renewDays').value=7">+Û· Ø±ÙˆØ²</button>
        <button class="btn btn-outline btn-sm" onclick="document.getElementById('renewDays').value=30">+Û³Û° Ø±ÙˆØ²</button>
        <button class="btn btn-outline btn-sm" onclick="document.getElementById('renewDays').value=90">+Û³ Ù…Ø§Ù‡</button>
      </div>
    </div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:9px;margin:14px 0">
      <div class="sum-card"><div class="sum-val c-purple" style="font-size:18px">${toPNum(sr.length)}</div><div class="sum-lbl">Ú¯Ø²Ø§Ø±Ø´</div></div>
      <div class="sum-card"><div class="sum-val c-gold" style="font-size:18px">${toPNum(se.length)}</div><div class="sum-lbl">Ø¢Ø²Ù…ÙˆÙ†</div></div>
    </div>
    <div style="font-size:12px;font-weight:700;color:var(--text-dim);margin-bottom:8px">Ø¢Ø®Ø±ÛŒÙ† Ú¯Ø²Ø§Ø±Ø´â€ŒÙ‡Ø§:</div>
    ${sr.slice(0,3).map(r=>`<div class="report-row" onclick="closeModal('studentModal');openReportModal('${r.id}')" style="margin-bottom:6px">
      <div style="font-size:12px;font-weight:700">${gregorianToJalaliStr(r.date)}</div>
      <div style="font-size:11px;color:var(--text-dim)">â±ï¸ ${toPNum(Math.floor(r.total_mins/60))}:${String(r.total_mins%60).padStart(2,'0')}</div>
      ${satBadge(r.satisfaction)}
    </div>`).join('')}`;
  document.getElementById('studentModal').classList.add('open');
}

async function deleteStudent(code){
  if(!confirm('Ù…Ø·Ù…Ø¦Ù†ÛŒØŸ ØªÙ…Ø§Ù… Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ Ø­Ø°Ù Ù…ÛŒØ´Ù‡'))return;
  showLoading('Ø¯Ø± Ø­Ø§Ù„ Ø­Ø°Ù...');
  await Promise.all([db.from('students').delete().eq('code',code),db.from('reports').delete().eq('student_code',code),db.from('exams').delete().eq('student_code',code)]);
  closeModal('studentModal');await refreshAll();hideLoading();showToast('Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ² Ø­Ø°Ù Ø´Ø¯');
}

function copyCode(code){navigator.clipboard.writeText(code).catch(()=>{});showToast(`Ú©Ø¯ ${code} Ú©Ù¾ÛŒ Ø´Ø¯`);}
function closeModal(id){document.getElementById(id).classList.remove('open');}
document.querySelectorAll('.modal-overlay').forEach(el=>el.addEventListener('click',e=>{if(e.target===el)el.classList.remove('open');}));

// ===== CHART ENGINE =====
function drawLine(canvasId,labels,data,color){
  const canvas=document.getElementById(canvasId);if(!canvas)return;
  canvas.width=canvas.offsetWidth||700;const ctx=canvas.getContext('2d');
  const W=canvas.width,H=canvas.height,pad={top:14,right:12,bottom:34,left:42};
  const cW=W-pad.left-pad.right,cH=H-pad.top-pad.bottom;
  ctx.clearRect(0,0,W,H);
  if(!data.length){ctx.fillStyle='#64748b';ctx.font='12px Vazirmatn';ctx.textAlign='center';ctx.fillText('Ø¯Ø§Ø¯Ù‡â€ŒØ§ÛŒ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯',W/2,H/2);return;}
  const max=Math.max(...data,1),n=data.length;
  const toX=i=>pad.left+(n>1?i*(cW/(n-1)):cW/2);
  const toY=v=>pad.top+cH-(v/max)*cH;
  ctx.strokeStyle='rgba(255,255,255,0.04)';ctx.lineWidth=1;
  for(let i=0;i<=4;i++){const y=pad.top+cH*(1-i/4);ctx.beginPath();ctx.moveTo(pad.left,y);ctx.lineTo(pad.left+cW,y);ctx.stroke();ctx.fillStyle='#64748b';ctx.font='9px Vazirmatn';ctx.textAlign='right';ctx.fillText((max*i/4).toFixed(0),pad.left-4,y+3);}
  if(n>1){const g=ctx.createLinearGradient(0,pad.top,0,pad.top+cH);g.addColorStop(0,color+'35');g.addColorStop(1,color+'00');ctx.fillStyle=g;ctx.beginPath();ctx.moveTo(toX(0),toY(data[0]));for(let i=1;i<n;i++)ctx.lineTo(toX(i),toY(data[i]));ctx.lineTo(toX(n-1),pad.top+cH);ctx.lineTo(toX(0),pad.top+cH);ctx.closePath();ctx.fill();}
  ctx.strokeStyle=color;ctx.lineWidth=2.5;ctx.lineJoin='round';ctx.beginPath();data.forEach((d,i)=>{if(i===0)ctx.moveTo(toX(i),toY(d));else ctx.lineTo(toX(i),toY(d));});ctx.stroke();
  data.forEach((d,i)=>{const x=toX(i),y=toY(d);ctx.fillStyle='#06080f';ctx.beginPath();ctx.arc(x,y,5,0,Math.PI*2);ctx.fill();ctx.fillStyle=color;ctx.beginPath();ctx.arc(x,y,3.5,0,Math.PI*2);ctx.fill();ctx.fillStyle='#64748b';ctx.font='9px Vazirmatn';ctx.textAlign='center';ctx.fillText((labels[i]||'').split('\n')[0],x,H-6);ctx.fillStyle=color;ctx.font='bold 10px Vazirmatn';ctx.fillText(toPNum(d),x,y-9);});
}

// ===== HELPERS =====
function toPNum(n){return String(n).replace(/\d/g,d=>'Û°Û±Û²Û³Û´ÛµÛ¶Û·Û¸Û¹'[d])}
function satBadge(v){const c=v>=70?'bg-green':v>=40?'bg-amber':'bg-red';return`<span class="badge ${c}">${toPNum(v)}Ùª</span>`}
function showToast(msg,type){const t=document.getElementById('toast');t.textContent=msg;t.style.background=type==='warn'?'var(--warning)':'var(--success)';t.classList.add('show');setTimeout(()=>t.classList.remove('show'),3200);}

// ===== INIT =====
(async()=>{
  showLoading('Ø¯Ø± Ø­Ø§Ù„ Ø§ØªØµØ§Ù„...');
  try{
    const[s,r,e]=await Promise.all([db.from('students').select('*'),db.from('reports').select('*'),db.from('exams').select('*')]);
    cachedStudents=s.data||[];cachedReports=r.data||[];cachedExams=e.data||[];
  }catch(err){console.log(err);}
  hideLoading();
})();
</script>
</body>
</html>
